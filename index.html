<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英雄联盟卡牌收藏家</title>
    <style>
        :root {
            --common: #a0a0a0;
            --rare: #0070ff;
            --epic: #a335ee;
            --legendary: #ff8000;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #0e0e1a;
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        h1 {
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            margin: 10px 0;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            margin: 0;
        }
        
        .currency {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            margin: 15px 0;
            color: #f0a400;
        }
        
        .packs-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .pack {
            width: 100%;
            max-width: 300px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .pack:hover {
            transform: translateY(-5px);
        }
        
        .pack img {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .pack h3 {
            margin: 5px 0;
            font-size: clamp(1rem, 4vw, 1.3rem);
            color: #f0a400;
        }
        
        .pack p {
            margin: 3px 0;
            font-size: clamp(0.8rem, 3vw, 1rem);
        }
        
        .pack-price {
            font-weight: bold;
            color: #f0a400;
            font-size: clamp(1rem, 4vw, 1.2rem);
            margin: 8px 0;
        }
        
        .pack-info-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn {
            background: linear-gradient(135deg, #f0a400, #ff6b00);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            margin: 8px 0;
            transition: transform 0.2s;
            font-size: clamp(0.8rem, 3vw, 1rem);
            width: 90%;
            max-width: 180px;
        }
        
        .btn:hover {
            transform: scale(1.05);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4a4a6e, #3a3a5e);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4d4d, #cc0000);
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 15px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .card {
            width: 140px;
            height: 210px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 8px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        
        @media (max-width: 480px) {
            .card {
                width: 120px;
                height: 180px;
            }
        }
        
        .card.flipped {
            transform: rotateY(180deg);
        }
        
        .card.selected {
            box-shadow: 0 0 10px 3px rgba(255, 255, 255, 0.5);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .card-front {
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
        }
        
        .card-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            object-position: center top;
        }
        
        @media (max-width: 480px) {
            .card-image {
                height: 120px;
            }
        }
        
        .card-info {
            padding: 8px;
            text-align: center;
        }
        
        .card-name {
            font-weight: bold;
            margin: 3px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: clamp(0.7rem, 3vw, 0.9rem);
        }
        
        .card-type {
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
            color: #aaa;
        }
        
        .card-back {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            transform: rotateY(180deg);
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .card-rarity {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
        }
        
        .common { color: var(--common); }
        .rare { color: var(--rare); }
        .epic { color: var(--epic); }
        .legendary { color: var(--legendary); }
        
        .card-value {
            background: rgba(0,0,0,0.5);
            padding: 3px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
        }
        
        .sell-btn {
            background: linear-gradient(135deg, #ff4d4d, #cc0000);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
        }
        
        .new-card-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 15px;
        }
        
        .new-card-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%;
            max-width: 800px;
            padding: 15px;
        }
        
        .new-card {
            width: 150px;
            height: 225px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 8px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        
        @media (max-width: 480px) {
            .new-card {
                width: 130px;
                height: 195px;
            }
        }
        
        .new-card.flipped {
            transform: rotateY(180deg);
        }
        
        .rarity-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            opacity: 0.3;
        }
        
        .common-effect { background: radial-gradient(circle, var(--common) 0%, transparent 70%); }
        .rare-effect { background: radial-gradient(circle, var(--rare) 0%, transparent 70%); }
        .epic-effect { background: radial-gradient(circle, var(--epic) 0%, transparent 70%); }
        .legendary-effect { 
            background: radial-gradient(circle, var(--legendary) 0%, transparent 70%);
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { opacity: 0.3; }
            to { opacity: 0.7; }
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            font-size: clamp(1rem, 5vw, 1.5rem);
        }
        
        @keyframes flipIn {
            0% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }
        
        .new-card {
            animation: flipIn 0.6s ease-out;
        }
        
        /* 手机横屏适配 */
        @media (orientation: landscape) and (max-height: 500px) {
            .pack {
                max-width: 200px;
                padding: 10px;
            }
            
            .card, .new-card {
                width: 100px;
                height: 150px;
            }
            
            .card-image {
                height: 100px;
            }
        }
        
        /* 卡片信息展示样式 */
        .pack-card-examples {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .pack-card-example {
            width: 100px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .pack-card-image {
            width: 80px;
            height: 120px;
            margin: 0 auto 5px;
            border-radius: 5px;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
        }
        
        .pack-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .pack-card-name {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .pack-card-rarity {
            font-size: 10px;
        }
        
        /* 修复卡片背面布局 */
        .card-back > div:first-child {
            flex: 1;
            overflow: hidden;
        }
        
        .card-back h3 {
            margin: 5px 0;
            font-size: clamp(0.8rem, 3vw, 1rem);
        }
        
        .card-back p {
            margin: 3px 0;
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
        }
        
        .card-value {
            margin-top: 8px;
        }
        
        /* 图鉴样式 */
        .handbook-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .handbook-card {
            width: 100px;
            height: 150px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .handbook-card:hover {
            transform: scale(1.05);
        }
        
        .handbook-card.uncollected {
            filter: grayscale(100%);
            opacity: 0.7;
        }
        
        .handbook-card-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            object-position: center top;
        }
        
        .handbook-card-info {
            padding: 5px;
            text-align: center;
        }
        
        .handbook-card-name {
            font-weight: bold;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .handbook-card-type {
            font-size: 10px;
            color: #aaa;
        }
        
        .handbook-card-rarity {
            font-size: 10px;
            margin-top: 3px;
        }
        
        /* 批量出售样式 */
        .bulk-sell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .bulk-sell-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .bulk-sell-actions {
            display: flex;
            gap: 10px;
        }
        
        .bulk-sell-options {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .bulk-sell-option {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .bulk-sell-option.selected {
            background: rgba(255,0,0,0.3);
            border-color: #ff0000;
        }
        
        .bulk-sell-option.common.selected {
            background: rgba(160,160,160,0.3);
            border-color: var(--common);
        }
        
        .bulk-sell-option.rare.selected {
            background: rgba(0,112,255,0.3);
            border-color: var(--rare);
        }
        
        .bulk-sell-option.epic.selected {
            background: rgba(163,53,238,0.3);
            border-color: var(--epic);
        }
        
        .bulk-sell-option.legendary.selected {
            background: rgba(255,128,0,0.3);
            border-color: var(--legendary);
        }
        
        /* 选项卡样式 */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .tab {
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin: 0 5px;
        }
        
        .tab.active {
            background: rgba(255,255,255,0.1);
            border-bottom: 2px solid #f0a400;
        }
        
        /* 响应式调整 */
        @media (max-width: 600px) {
            .handbook-card {
                width: 80px;
                height: 130px;
            }
            
            .handbook-card-image {
                height: 80px;
            }
            
            .handbook-card-name {
                font-size: 10px;
            }
            
            .bulk-sell-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .bulk-sell-controls {
                flex-direction: column;
            }
            
            .bulk-sell-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">正在初始化游戏...</div>
    
    <div class="container">
        <header>
            <h1>英雄联盟卡牌收藏家</h1>
            <div class="currency">金币: <span id="gold">1000</span></div>
        </header>
        
        <h2>选择卡包</h2>
        <div class="packs-section">
            <div class="pack" data-pack-type="basic">
                <button class="pack-info-btn">i</button>
                <img src="https://ddragon.leagueoflegends.com/cdn/13.1.0/img/profileicon/588.png" alt="基础卡包">
                <h3>基础卡包</h3>
                <p>5张随机卡牌</p>
                <p>包含英雄和普通皮肤</p>
                <p class="pack-price">200金币</p>
                <button class="btn open-pack-btn" data-pack-type="basic">购买并开启</button>
            </div>
            <div class="pack" data-pack-type="premium">
                <button class="pack-info-btn">i</button>
                <img src="https://ddragon.leagueoflegends.com/cdn/13.1.0/img/profileicon/23.png" alt="高级卡包">
                <h3>高级卡包</h3>
                <p>5张随机卡牌</p>
                <p>包含稀有和史诗皮肤</p>
                <p class="pack-price">500金币</p>
                <button class="btn open-pack-btn" data-pack-type="premium">购买并开启</button>
            </div>
            <div class="pack" data-pack-type="luxury">
                <button class="pack-info-btn">i</button>
                <img src="https://ddragon.leagueoflegends.com/cdn/13.1.0/img/profileicon/1.png" alt="豪华卡包">
                <h3>豪华卡包</h3>
                <p>5张随机卡牌</p>
                <p>包含传说和终极皮肤</p>
                <p class="pack-price">1000金币</p>
                <button class="btn open-pack-btn" data-pack-type="luxury">购买并开启</button>
            </div>
        </div>
        
        <div class="section-header">
            <div class="section-title">
                <h2>你的收藏</h2>
                <span id="collection-count">(0)</span>
            </div>
            <div>
                <button class="btn btn-secondary btn-sm" id="handbook-btn">图鉴</button>
                <button class="btn btn-danger btn-sm" id="bulk-sell-btn">批量出售</button>
            </div>
        </div>
        <div class="cards-container" id="cards-container">
            <!-- 卡片将在这里动态生成 -->
        </div>
    </div>
    
    <!-- 卡包信息模态框 -->
    <div class="modal" id="pack-info-modal">
        <div class="modal-content">
            <button class="close-modal">×</button>
            <h2 id="pack-info-title">卡包信息</h2>
            <div id="pack-info-content">
                <!-- 卡包信息将在这里动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 新卡片展示模态框 -->
    <div class="new-card-modal" id="new-card-modal">
        <div>
            <h2>你获得了以下卡牌！</h2>
            <div class="new-card-container" id="new-card-container">
                <!-- 新卡片将在这里动态生成 -->
            </div>
            <button class="btn close-new-cards-btn">确认</button>
        </div>
    </div>
    
    <!-- 图鉴模态框 -->
    <div class="modal" id="handbook-modal">
        <div class="modal-content">
            <button class="close-modal">×</button>
            <h2>图鉴</h2>
            <div class="tabs">
                <div class="tab active" data-tab="champions">英雄</div>
                <div class="tab" data-tab="skins">皮肤</div>
            </div>
            <div class="handbook-container" id="handbook-content">
                <!-- 图鉴内容将在这里动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 批量出售模态框 -->
    <div class="modal" id="bulk-sell-modal">
        <div class="modal-content">
            <button class="close-modal">×</button>
            <div class="bulk-sell-header">
                <h2>批量出售</h2>
                <div class="bulk-sell-actions">
                    <button class="btn btn-secondary btn-sm" id="select-all-btn">全选</button>
                    <button class="btn btn-secondary btn-sm" id="deselect-all-btn">取消全选</button>
                    <button class="btn btn-danger btn-sm" id="confirm-bulk-sell">出售选中</button>
                </div>
            </div>
            
            <div class="bulk-sell-controls">
                <div class="bulk-sell-options">
                    <div class="bulk-sell-option common" data-rarity="common">普通</div>
                    <div class="bulk-sell-option rare" data-rarity="rare">稀有</div>
                    <div class="bulk-sell-option epic" data-rarity="epic">史诗</div>
                    <div class="bulk-sell-option legendary" data-rarity="legendary">传说</div>
                </div>
            </div>
            
            <div class="cards-container" id="bulk-sell-container">
                <!-- 批量出售的卡片将在这里动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let gold = 1000;
        let collection = [];
        let allChampions = [];
        let allSkins = [];
        let collectedCards = {
            champions: new Set(),
            skins: new Set()
        };
        const CURRENT_VERSION = '14.14.1';
        
        // 初始化函数
        async function init() {
            showLoading(true);
            try {
                // 尝试从API加载数据，失败则使用模拟数据
                try {
                    await loadAllChampions();
                    await loadAllSkins();
                } catch (apiError) {
                    console.warn('API加载失败，使用模拟数据:', apiError);
                    useMockData();
                }
                
                // 加载本地存储的数据
                loadLocalData();
                
                updateGoldDisplay();
                updateCollectionCount();
                
                // 添加事件监听器
                setupEventListeners();
                
            } catch (error) {
                console.error('初始化失败:', error);
                showLoading(false, '初始化失败: ' + error.message);
                setTimeout(() => {
                    showLoading(false);
                    alert('游戏初始化失败，请刷新页面重试\n错误信息: ' + error.message);
                }, 2000);
            } finally {
                setTimeout(() => {
                    showLoading(false);
                    if (allChampions.length === 0 || allSkins.length === 0) {
                        alert('警告：未能加载完整数据，部分功能可能受限');
                    }
                }, 500);
            }
        }
        
        // 使用模拟数据
        function useMockData() {
            allChampions = [
                { id: "Ashe", name: "艾希", title: "寒冰射手" },
                { id: "Garen", name: "盖伦", title: "德玛西亚之力" },
                { id: "Lux", name: "拉克丝", title: "光辉女郎" },
                { id: "Ezreal", name: "伊泽瑞尔", title: "探险家" },
                { id: "Ahri", name: "阿狸", title: "九尾妖狐" }
            ];
            
            allSkins = [
                { id: 1000, num: 1, name: "女皇艾希", championId: "Ashe", championName: "艾希", championTitle: "寒冰射手", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ashe.png" },
                { id: 1001, num: 2, name: "极地女神艾希", championId: "Ashe", championName: "艾希", championTitle: "寒冰射手", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ashe.png" },
                { id: 1002, num: 3, name: "冠军艾希", championId: "Ashe", championName: "艾希", championTitle: "寒冰射手", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ashe.png" },
                { id: 2000, num: 1, name: "钢铁军团盖伦", championId: "Garen", championName: "盖伦", championTitle: "德玛西亚之力", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Garen.png" },
                { id: 2001, num: 2, name: "战神盖伦", championId: "Garen", championName: "盖伦", championTitle: "德玛西亚之力", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Garen.png" },
                { id: 2002, num: 3, name: "神王盖伦", championId: "Garen", championName: "盖伦", championTitle: "德玛西亚之力", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Garen.png" },
                { id: 4000, num: 1, name: "奥术光辉拉克丝", championId: "Lux", championName: "拉克丝", championTitle: "光辉女郎", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Lux.png" },
                { id: 4001, num: 2, name: "星之守护者拉克丝", championId: "Lux", championName: "拉克丝", championTitle: "光辉女郎", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Lux.png" },
                { id: 4002, num: 3, name: "元素女皇拉克丝", championId: "Lux", championName: "拉克丝", championTitle: "光辉女郎", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Lux.png" },
                { id: 5000, num: 1, name: "足球先生伊泽瑞尔", championId: "Ezreal", championName: "伊泽瑞尔", championTitle: "探险家", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ezreal.png" },
                { id: 5001, num: 2, name: "未来战士伊泽瑞尔", championId: "Ezreal", championName: "伊泽瑞尔", championTitle: "探险家", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ezreal.png" },
                { id: 5002, num: 3, name: "星之守护者伊泽瑞尔", championId: "Ezreal", championName: "伊泽瑞尔", championTitle: "探险家", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ezreal.png" },
                { id: 9000, num: 1, name: "高丽风情阿狸", championId: "Ahri", championName: "阿狸", championTitle: "九尾妖狐", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ahri.png" },
                { id: 9001, num: 2, name: "星之守护者阿狸", championId: "Ahri", championName: "阿狸", championTitle: "九尾妖狐", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ahri.png" },
                { id: 9002, num: 3, name: "偶像歌手阿狸", championId: "Ahri", championName: "阿狸", championTitle: "九尾妖狐", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ahri.png" }
            ];
        }
        
        // 加载本地存储的数据
        function loadLocalData() {
            const savedData = localStorage.getItem('lolCardCollector');
            if (savedData) {
                const data = JSON.parse(savedData);
                gold = data.gold || 1000;
                collection = data.collection || [];
                collectedCards = data.collectedCards || {
                    champions: new Set(),
                    skins: new Set()
                };
                
                // 转换Set对象（因为JSON.stringify会忽略Set）
                if (data.collectedCards) {
                    collectedCards.champions = new Set(data.collectedCards.champions);
                    collectedCards.skins = new Set(data.collectedCards.skins);
                }
            }
        }
        
        // 保存数据到本地存储
        function saveLocalData() {
            const data = {
                gold,
                collection,
                collectedCards: {
                    champions: Array.from(collectedCards.champions),
                    skins: Array.from(collectedCards.skins)
                }
            };
            localStorage.setItem('lolCardCollector', JSON.stringify(data));
        }
        
        // 加载所有英雄数据
        async function loadAllChampions() {
            const response = await fetch(`https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/data/zh_CN/champion.json`);
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Expected JSON but got: ${text.substring(0, 100)}...`);
            }
            
            const data = await response.json();
            
            allChampions = Object.values(data.data).map(champ => ({
                id: champ.id,
                key: champ.key,
                name: champ.name,
                title: champ.title
            }));
        }
        
        // 加载所有皮肤数据
        async function loadAllSkins() {
            allSkins = [];
            
            // 优化加载速度，只加载前20个英雄的皮肤
            const championsToLoad = allChampions.slice(0, 20);
            
            for (const champ of championsToLoad) {
                try {
                    const response = await fetch(`https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/data/zh_CN/champion/${champ.id}.json`);
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.warn(`英雄 ${champ.name} 的皮肤数据不是JSON格式`);
                        continue;
                    }
                    
                    const data = await response.json();
                    const championData = data.data[champ.id];
                    
                    championData.skins.forEach(skin => {
                        if (skin.num > 0) {
                            allSkins.push({
                                id: skin.id,
                                num: skin.num,
                                name: skin.name,
                                championId: champ.id,
                                championName: champ.name,
                                championTitle: champ.title,
                                loadingImg: `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${champ.id}_${skin.num}.jpg`,
                                portraitImg: `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${champ.id}.png`
                            });
                        }
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 50));
                } catch (error) {
                    console.error(`加载英雄 ${champ.name} 的皮肤数据失败:`, error);
                }
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 开包按钮
            document.querySelectorAll('.open-pack-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const packType = this.getAttribute('data-pack-type');
                    openPack(packType);
                });
            });
            
            // 卡包信息按钮
            document.querySelectorAll('.pack-info-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const packType = this.closest('.pack').getAttribute('data-pack-type');
                    showPackInfo(packType);
                });
            });
            
            // 关闭模态框按钮
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalId = this.closest('.modal').id;
                    closeModal(modalId);
                });
            });
            
            // 关闭新卡片展示按钮
            document.querySelector('.close-new-cards-btn').addEventListener('click', function() {
                closeModal('new-card-modal');
            });
            
            // 使用事件委托处理出售按钮点击事件
            document.getElementById('cards-container').addEventListener('click', function(e) {
                if (e.target.classList.contains('sell-btn')) {
                    const cardIndex = parseInt(e.target.getAttribute('data-index'));
                    sellCard(cardIndex);
                }
            });
            
            // 图鉴按钮
            document.getElementById('handbook-btn').addEventListener('click', function() {
                showHandbook();
            });
            
            // 批量出售按钮
            document.getElementById('bulk-sell-btn').addEventListener('click', function() {
                showBulkSellModal();
            });
            
            // 确认批量出售按钮
            document.getElementById('confirm-bulk-sell').addEventListener('click', function() {
                confirmBulkSell();
            });
            
            // 全选按钮
            document.getElementById('select-all-btn').addEventListener('click', function() {
                selectAllCards(true);
            });
            
            // 取消全选按钮
            document.getElementById('deselect-all-btn').addEventListener('click', function() {
                selectAllCards(false);
            });
            
            // 图鉴选项卡
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.getAttribute('data-tab');
                    switchHandbookTab(tabType);
                });
            });
            
            // 批量出售选项
            document.querySelectorAll('.bulk-sell-option').forEach(option => {
                option.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    filterBulkSellCards();
                });
            });
        }
        
        // 显示/隐藏加载指示器
        function showLoading(show, message = '正在初始化游戏...') {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = show ? 'flex' : 'none';
            loadingElement.textContent = message;
        }
        
        // 更新金币显示
        function updateGoldDisplay() {
            document.getElementById('gold').textContent = gold;
            document.querySelectorAll('.open-pack-btn').forEach(btn => {
                const packType = btn.getAttribute('data-pack-type');
                const packPrice = getPackPrice(packType);
                btn.disabled = gold < packPrice;
            });
            saveLocalData();
        }
        
        // 获取卡包价格
        function getPackPrice(packType) {
            switch(packType) {
                case 'basic': return 200;
                case 'premium': return 500;
                case 'luxury': return 1000;
                default: return 0;
            }
        }
        
        // 更新收藏数量显示
        function updateCollectionCount() {
            const count = collection.length;
            document.getElementById('collection-count').textContent = `(${count})`;
            saveLocalData();
        }
        
        // 渲染收藏
        function renderCollection() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            if (collection.length === 0) {
                container.innerHTML = '<p>你还没有任何卡片，快去开包吧！</p>';
                return;
            }
            
            collection.forEach((card, index) => {
                const cardElement = createCardElement(card, index);
                container.appendChild(cardElement);
            });
        }
        
        // 创建卡片元素
        function createCardElement(card, index) {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            
            let imageUrl, cardTitle, cardName;
            if (card.type === 'skin') {
                imageUrl = card.skin.loadingImg;
                cardTitle = `${card.skin.name}`;
                cardName = card.skin.name;
            } else {
                imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${card.championId}_0.jpg`;
                cardTitle = card.title;
                cardName = card.name;
            }
            
            const cardValue = calculateCardValue(card);
            
            cardElement.innerHTML = `
                <div class="card-face card-front">
                    <img class="card-image" src="${imageUrl}" alt="${cardName}" 
                         onerror="this.src='${card.type === 'skin' ? card.skin.portraitImg : `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${card.championId}.png`}'">
                    <div class="card-info">
                        <div class="card-name">${cardName}</div>
                        <div class="card-type">${card.type === 'skin' ? '皮肤' : '英雄'}</div>
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                </div>
                <div class="card-face card-back">
                    <div>
                        <h3>${cardName}</h3>
                        <p>${cardTitle}</p>
                        ${card.type === 'skin' ? `<p>英雄: ${card.skin.championName}</p>` : ''}
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                    <div class="card-value">
                        <p>价值: ${cardValue}金币</p>
                        <button class="sell-btn" data-index="${index}">出售</button>
                    </div>
                </div>
            `;
            
            cardElement.addEventListener('click', function(e) {
                if (!e.target.classList.contains('sell-btn')) {
                    this.classList.toggle('flipped');
                }
            });
            
            return cardElement;
        }
        
        // 创建新卡片元素（用于展示）
        function createNewCardElement(card) {
            const cardElement = document.createElement('div');
            cardElement.className = 'new-card';
            
            let imageUrl, cardTitle, cardName;
            if (card.type === 'skin') {
                imageUrl = card.skin.loadingImg;
                cardTitle = `${card.skin.name}`;
                cardName = card.skin.name;
            } else {
                imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${card.championId}_0.jpg`;
                cardTitle = card.title;
                cardName = card.name;
            }
            
            const cardValue = calculateCardValue(card);
            
            cardElement.innerHTML = `
                <div class="rarity-effects ${card.rarity}-effect"></div>
                <div class="card-face card-front">
                    <img class="card-image" src="${imageUrl}" alt="${cardName}" 
                         onerror="this.src='${card.type === 'skin' ? card.skin.portraitImg : `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${card.championId}.png`}'">
                    <div class="card-info">
                        <div class="card-name">${cardName}</div>
                        <div class="card-type">${card.type === 'skin' ? '皮肤' : '英雄'}</div>
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                </div>
                <div class="card-face card-back">
                    <div>
                        <h3>${cardName}</h3>
                        <p>${cardTitle}</p>
                        ${card.type === 'skin' ? `<p>英雄: ${card.skin.championName}</p>` : ''}
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                    <div class="card-value">
                        <p>价值: ${cardValue}金币</p>
                    </div>
                </div>
            `;
            
            cardElement.addEventListener('click', function() {
                this.classList.toggle('flipped');
            });
            
            return cardElement;
        }
        
        // 计算卡片价值
        function calculateCardValue(card) {
            let baseValue = 0;
            
            switch(card.rarity) {
                case 'common':
                    baseValue = card.type === 'skin' ? 
                        Math.floor(Math.random() * 101) + 100 : 
                        Math.floor(Math.random() * 51) + 50;
                    break;
                case 'rare':
                    baseValue = card.type === 'skin' ? 
                        Math.floor(Math.random() * 151) + 250 : 
                        Math.floor(Math.random() * 101) + 150;
                    break;
                case 'epic':
                    baseValue = card.type === 'skin' ? 
                        Math.floor(Math.random() * 301) + 500 : 
                        Math.floor(Math.random() * 201) + 300;
                    break;
                case 'legendary':
                    baseValue = card.type === 'skin' ? 
                        Math.floor(Math.random() * 1001) + 1000 : 
                        Math.floor(Math.random() * 401) + 600;
                    break;
            }
            
            if (card.type === 'skin') {
                baseValue = Math.floor(baseValue * 1.5);
            }
            
            card.value = baseValue;
            return baseValue;
        }
        
        // 获取稀有度名称
        function getRarityName(rarity) {
            switch(rarity) {
                case 'common': return '普通';
                case 'rare': return '稀有';
                case 'epic': return '史诗';
                case 'legendary': return '传说';
                default: return '普通';
            }
        }
        
        // 开包函数
        async function openPack(packType) {
            const packPrice = getPackPrice(packType);
            
            if (gold < packPrice) {
                alert('金币不足！');
                return;
            }
            
            showLoading(true, '正在开启卡包...');
            
            try {
                gold -= packPrice;
                updateGoldDisplay();
                
                const newCards = [];
                
                for (let i = 0; i < 5; i++) {
                    let rarity;
                    const rand = Math.random();
                    
                    switch(packType) {
                        case 'basic':
                            if (rand < 0.75) rarity = 'common';
                            else if (rand < 0.95) rarity = 'rare';
                            else if (rand < 0.99) rarity = 'epic';
                            else rarity = 'legendary';
                            break;
                        case 'premium':
                            if (rand < 0.5) rarity = 'common';
                            else if (rand < 0.85) rarity = 'rare';
                            else if (rand < 0.98) rarity = 'epic';
                            else rarity = 'legendary';
                            break;
                        case 'luxury':
                            if (rand < 0.3) rarity = 'common';
                            else if (rand < 0.65) rarity = 'rare';
                            else if (rand < 0.9) rarity = 'epic';
                            else rarity = 'legendary';
                            break;
                    }
                    
                    const isSkin = (rarity !== 'common' && Math.random() > 0.5) || 
                                  (packType === 'luxury' && Math.random() > 0.3);
                    
                    if (isSkin && allSkins.length > 0) {
                        let eligibleSkins = allSkins;
                        if (packType === 'luxury') {
                            eligibleSkins = allSkins.filter(skin => skin.num >= 5);
                        } else if (packType === 'premium') {
                            eligibleSkins = allSkins.filter(skin => skin.num > 0 && skin.num < 10);
                        }
                        
                        if (eligibleSkins.length > 0) {
                            const randomIndex = Math.floor(Math.random() * eligibleSkins.length);
                            const randomSkin = eligibleSkins[randomIndex];
                            
                            const newCard = {
                                type: 'skin',
                                skin: randomSkin,
                                championId: randomSkin.championId,
                                name: randomSkin.name,
                                title: randomSkin.name,
                                rarity: rarity,
                                obtained: new Date().toLocaleDateString()
                            };
                            
                            // 添加到已收集皮肤
                            collectedCards.skins.add(randomSkin.id);
                            
                            calculateCardValue(newCard);
                            newCards.push(newCard);
                            continue;
                        }
                    }
                    
                    // 英雄卡
                    if (allChampions.length > 0) {
                        const randomIndex = Math.floor(Math.random() * allChampions.length);
                        const randomChampion = allChampions[randomIndex];
                        
                        const newCard = {
                            type: 'champion',
                            championId: randomChampion.id,
                            name: randomChampion.name,
                            title: randomChampion.title,
                            rarity: rarity,
                            obtained: new Date().toLocaleDateString()
                        };
                        
                        // 添加到已收集英雄
                        collectedCards.champions.add(randomChampion.id);
                        
                        calculateCardValue(newCard);
                        newCards.push(newCard);
                    }
                }
                
                collection = collection.concat(newCards);
                updateCollectionCount();
                showNewCards(newCards);
                renderCollection();
                
            } catch (error) {
                console.error('开包出错:', error);
                alert('开包失败，请重试！');
                gold += packPrice;
                updateGoldDisplay();
            } finally {
                showLoading(false);
            }
        }
        
        // 显示新卡片
        function showNewCards(cards) {
            const container = document.getElementById('new-card-container');
            container.innerHTML = '';
            
            cards.forEach(card => {
                const cardElement = createNewCardElement(card);
                container.appendChild(cardElement);
                
                setTimeout(() => {
                    cardElement.classList.add('flipped');
                }, 200);
            });
            
            document.getElementById('new-card-modal').style.display = 'flex';
        }
        
        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // 出售卡片
        function sellCard(index) {
            if (index >= 0 && index < collection.length) {
                const card = collection[index];
                const confirmSell = confirm(`确定要出售 ${card.name} 吗？\n获得 ${card.value} 金币`);
                
                if (confirmSell) {
                    gold += card.value;
                    collection.splice(index, 1);
                    updateGoldDisplay();
                    renderCollection();
                    updateCollectionCount();
                }
            }
        }
        
        // 显示卡包信息
        function showPackInfo(packType) {
            const modal = document.getElementById('pack-info-modal');
            const title = document.getElementById('pack-info-title');
            const content = document.getElementById('pack-info-content');
            
            let packName, packDesc;
            
            switch(packType) {
                case 'basic':
                    packName = '基础卡包';
                    packDesc = '包含5张随机卡牌，主要包含普通品质的英雄和皮肤';
                    break;
                case 'premium':
                    packName = '高级卡包';
                    packDesc = '包含5张随机卡牌，主要包含稀有和史诗品质的皮肤';
                    break;
                case 'luxury':
                    packName = '豪华卡包';
                    packDesc = '包含5张随机卡牌，主要包含史诗和传说品质的皮肤';
                    break;
            }
            
            title.textContent = packName;
            
            let exampleCardsHtml = '';
            
            let exampleCards;
            if (packType === 'basic') {
                exampleCards = [
                    { name: "艾希", type: "英雄", rarity: "common", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_0.jpg" },
                    { name: "盖伦", type: "英雄", rarity: "common", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_0.jpg" },
                    { name: "拉克丝", type: "英雄", rarity: "common", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_0.jpg" },
                    { name: "经典皮肤", type: "皮肤", rarity: "common", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_1.jpg" },
                    { name: "普通皮肤", type: "皮肤", rarity: "rare", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_1.jpg" }
                ];
            } else if (packType === 'premium') {
                exampleCards = [
                    { name: "神王盖伦", type: "皮肤", rarity: "epic", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_3.jpg" },
                    { name: "星之守护者拉克丝", type: "皮肤", rarity: "epic", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_2.jpg" },
                    { name: "未来战士伊泽瑞尔", type: "皮肤", rarity: "rare", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_2.jpg" },
                    { name: "元素女皇拉克丝", type: "皮肤", rarity: "epic", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_3.jpg" },
                    { name: "偶像歌手阿狸", type: "皮肤", rarity: "rare", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_3.jpg" }
                ];
            } else {
                exampleCards = [
                    { name: "K/DA阿狸", type: "皮肤", rarity: "legendary", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_8.jpg" },
                    { name: "真实伤害伊泽瑞尔", type: "皮肤", rarity: "legendary", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_8.jpg" },
                    { name: "奥德赛拉克丝", type: "皮肤", rarity: "epic", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_6.jpg" },
                    { name: "神王盖伦", type: "皮肤", rarity: "legendary", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_3.jpg" },
                    { name: "摄魂使者薇恩", type: "皮肤", rarity: "legendary", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Vayne_6.jpg" }
                ];
            }
            
            exampleCards.forEach(card => {
                exampleCardsHtml += `
                    <div class="pack-card-example">
                        <div class="pack-card-image">
                            <img src="${card.img}" alt="${card.name}" onerror="this.src='https://picsum.photos/80/120'">
                        </div>
                        <div class="pack-card-name">${card.name}</div>
                        <div class="pack-card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                `;
            });
            
            content.innerHTML = `
                <p>${packDesc}</p>
                <p class="pack-price">价格: ${getPackPrice(packType)}金币</p>
                <h3>可能包含的卡片:</h3>
                <div class="pack-card-examples">
                    ${exampleCardsHtml}
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // 显示图鉴
        function showHandbook() {
            const modal = document.getElementById('handbook-modal');
            modal.style.display = 'flex';
            
            // 默认显示英雄图鉴
            renderHandbook('champions');
        }
        
        // 渲染图鉴内容
        function renderHandbook(type) {
            const container = document.getElementById('handbook-content');
            container.innerHTML = '';
            
            if (type === 'champions') {
                allChampions.forEach(champ => {
                    const isCollected = collectedCards.champions.has(champ.id);
                    const cardElement = createHandbookCardElement(champ, isCollected, 'champion');
                    container.appendChild(cardElement);
                });
            } else {
                allSkins.forEach(skin => {
                    const isCollected = collectedCards.skins.has(skin.id);
                    const cardElement = createHandbookCardElement(skin, isCollected, 'skin');
                    container.appendChild(cardElement);
                });
            }
        }
        
        // 创建图鉴卡片元素
        function createHandbookCardElement(item, isCollected, type) {
            const cardElement = document.createElement('div');
            cardElement.className = `handbook-card ${isCollected ? '' : 'uncollected'}`;
            
            let imageUrl, name, subText;
            if (type === 'skin') {
                imageUrl = item.loadingImg;
                name = item.name;
                subText = item.championName;
            } else {
                imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${item.id}_0.jpg`;
                name = item.name;
                subText = item.title;
            }
            
            // 为图鉴卡片添加点击事件，显示详细信息
            cardElement.innerHTML = `
                <img class="handbook-card-image" src="${imageUrl}" alt="${name}" 
                     onerror="this.src='${type === 'skin' ? item.portraitImg : `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${item.id}.png`}'">
                <div class="handbook-card-info">
                    <div class="handbook-card-name">${name}</div>
                    <div class="handbook-card-type">${subText}</div>
                    <div class="handbook-card-rarity">${isCollected ? '已收集' : '未收集'}</div>
                </div>
            `;
            
            return cardElement;
        }
        
        // 切换图鉴选项卡
        function switchHandbookTab(tabType) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabType) {
                    tab.classList.add('active');
                }
            });
            
            renderHandbook(tabType);
        }
        
        // 显示批量出售模态框
        function showBulkSellModal() {
            const modal = document.getElementById('bulk-sell-modal');
            modal.style.display = 'flex';
            
            // 重置选择
            document.querySelectorAll('.bulk-sell-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 渲染所有卡片
            renderBulkSellCards();
        }
        
        // 渲染批量出售卡片
        function renderBulkSellCards() {
            const container = document.getElementById('bulk-sell-container');
            container.innerHTML = '';
            
            if (collection.length === 0) {
                container.innerHTML = '<p>没有可出售的卡片</p>';
                return;
            }
            
            collection.forEach((card, index) => {
                const cardElement = createBulkSellCardElement(card, index);
                container.appendChild(cardElement);
            });
        }
        
        // 创建批量出售卡片元素
        function createBulkSellCardElement(card, index) {
            const cardElement = document.createElement('div');
            cardElement.className = 'card bulk-sell-card';
            cardElement.setAttribute('data-rarity', card.rarity);
            
            let imageUrl, cardTitle, cardName;
            if (card.type === 'skin') {
                imageUrl = card.skin.loadingImg;
                cardTitle = `${card.skin.name}`;
                cardName = card.skin.name;
            } else {
                imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${card.championId}_0.jpg`;
                cardTitle = card.title;
                cardName = card.name;
            }
            
            cardElement.innerHTML = `
                <div class="card-face card-front">
                    <img class="card-image" src="${imageUrl}" alt="${cardName}" 
                         onerror="this.src='${card.type === 'skin' ? card.skin.portraitImg : `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${card.championId}.png`}'">
                    <div class="card-info">
                        <div class="card-name">${cardName}</div>
                        <div class="card-type">${card.type === 'skin' ? '皮肤' : '英雄'}</div>
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                </div>
                <div class="card-face card-back">
                    <div>
                        <h3>${cardName}</h3>
                        <p>${cardTitle}</p>
                        ${card.type === 'skin' ? `<p>英雄: ${card.skin.championName}</p>` : ''}
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                    <div class="card-value">
                        <p>价值: ${card.value}金币</p>
                        <button class="sell-btn" data-index="${index}">出售</button>
                    </div>
                </div>
            `;
            
            // 添加选择功能
            cardElement.addEventListener('click', function(e) {
                if (!e.target.classList.contains('sell-btn')) {
                    this.classList.toggle('selected');
                }
            });
            
            return cardElement;
        }
        
        // 筛选批量出售卡片
        function filterBulkSellCards() {
            const selectedRarities = Array.from(document.querySelectorAll('.bulk-sell-option.selected'))
                .map(option => option.getAttribute('data-rarity'));
            
            const cards = document.querySelectorAll('.bulk-sell-card');
            
            if (selectedRarities.length === 0) {
                cards.forEach(card => card.style.display = '');
                return;
            }
            
            cards.forEach(card => {
                const rarity = card.getAttribute('data-rarity');
                if (selectedRarities.includes(rarity)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // 全选/取消全选卡片
        function selectAllCards(select) {
            const visibleCards = Array.from(document.querySelectorAll('.bulk-sell-card'))
                .filter(card => window.getComputedStyle(card).display !== 'none');
            
            visibleCards.forEach(card => {
                if (select) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }
        
        // 确认批量出售
        function confirmBulkSell() {
            const selectedCards = Array.from(document.querySelectorAll('.bulk-sell-card.selected'));
            
            if (selectedCards.length === 0) {
                alert('请先选择要出售的卡片！');
                return;
            }
            
            const totalValue = selectedCards.reduce((sum, card) => {
                const index = parseInt(card.querySelector('.sell-btn').getAttribute('data-index'));
                return sum + collection[index].value;
            }, 0);
            
            const confirmSell = confirm(`确定要出售选中的 ${selectedCards.length} 张卡片吗？\n总共获得 ${totalValue} 金币`);
            
            if (confirmSell) {
                // 按索引从大到小排序，避免删除时索引变化
                const indices = selectedCards
                    .map(card => parseInt(card.querySelector('.sell-btn').getAttribute('data-index')))
                    .sort((a, b) => b - a);
                
                indices.forEach(index => {
                    gold += collection[index].value;
                    collection.splice(index, 1);
                });
                
                updateGoldDisplay();
                renderCollection();
                updateCollectionCount();
                closeModal('bulk-sell-modal');
                alert(`成功出售 ${indices.length} 张卡片，获得 ${totalValue} 金币！`);
            }
        }
        
        // 初始化游戏
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>