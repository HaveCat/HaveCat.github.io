<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英雄联盟卡牌收藏家</title>
    <style>
        :root {
            --common: #a0a0a0;
            --rare: #0070ff;
            --epic: #a335ee;
            --legendary: #ff8000;
            --bg-gradient-start: #0e0e1a;
            --bg-gradient-end: #1a1a3a;
            --card-bg: linear-gradient(135deg, #1a1a2e, #16213e);
            --card-border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: url('https://images.contentstack.io/v3/assets/blt731acb42bb3d1659/blt9d7d5d9e0b5b5b5b/5ebd3f5b0b2e456ea0e3a7e5/Homepage_Header.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            text-align: center;
            min-height: 100vh;
            padding-bottom: 20px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            margin-bottom: 20px;
            padding: 0 10px;
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(240, 164, 0, 0.3);
        }
        
        h1 {
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            margin: 10px 0;
            color: #f0a400;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            font-family: 'Beaufort for LOL', serif;
            letter-spacing: 1px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(240, 164, 0, 0.2);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            margin: 0;
            color: #f0a400;
            font-family: 'Beaufort for LOL', serif;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .currency {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            margin: 15px 0;
            color: #f0a400;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .packs-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .pack {
            width: 100%;
            max-width: 300px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            border: 1px solid rgba(240, 164, 0, 0.2);
        }
        
        .pack:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(240, 164, 0, 0.2);
        }
        
        .pack img {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid rgba(240, 164, 0, 0.3);
        }
        
        .pack h3 {
            margin: 5px 0;
            font-size: clamp(1rem, 4vw, 1.3rem);
            color: #f0a400;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .pack p {
            margin: 3px 0;
            font-size: clamp(0.8rem, 3vw, 1rem);
            color: #ccc;
        }
        
        .pack-price {
            font-weight: bold;
            color: #f0a400;
            font-size: clamp(1rem, 4vw, 1.2rem);
            margin: 8px 0;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .pack-info-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(240, 164, 0, 0.2);
            border: none;
            color: #fff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .pack-info-btn:hover {
            background: rgba(240, 164, 0, 0.4);
        }
        
        .btn {
            background: linear-gradient(135deg, #f0a400, #ff6b00);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            margin: 8px 0;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: clamp(0.8rem, 3vw, 1rem);
            width: 90%;
            max-width: 180px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 10px rgba(240, 164, 0, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4a4a6e, #3a3a5e);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4d4d, #cc0000);
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 15px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: rgba(26, 26, 46, 0.95);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(240, 164, 0, 0.3);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7);
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .close-modal:hover {
            background: rgba(240, 164, 0, 0.2);
        }
        
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .card {
            width: 140px;
            height: 210px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 8px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
            border: 1px solid rgba(240, 164, 0, 0.2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 480px) {
            .card {
                width: 120px;
                height: 180px;
            }
        }
        
        .card.flipped {
            transform: rotateY(180deg);
        }
        
        .card.selected {
            box-shadow: 0 0 10px 3px rgba(240, 164, 0, 0.5);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .card-front {
            background: rgba(26, 26, 46, 0.8);
        }
        
        .card-back {
            background: rgba(26, 26, 46, 0.9);
            transform: rotateY(180deg);
            padding: 10px;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .card-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            object-position: center top;
            border-bottom: 1px solid rgba(240, 164, 0, 0.2);
        }
        
        @media (max-width: 480px) {
            .card-image {
                height: 120px;
            }
        }
        
        .card-info {
            padding: 8px;
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .card-name {
            font-weight: bold;
            margin: 3px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: clamp(0.7rem, 3vw, 0.9rem);
        }
        
        .card-type {
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
            color: #aaa;
        }
        
        .card-rarity {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
        }
        
        .common { color: var(--common); }
        .rare { color: var(--rare); }
        .epic { color: var(--epic); }
        .legendary { color: var(--legendary); }
        
        .card-value {
            background: rgba(0,0,0,0.5);
            padding: 3px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
        }
        
        .sell-btn {
            background: linear-gradient(135deg, #ff4d4d, #cc0000);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
            font-size: clamp(0.6rem, 2.5vw, 0.8rem);
            transition: transform 0.2s;
        }
        
        .sell-btn:hover {
            transform: scale(1.05);
        }
        
        .new-card-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 15px;
        }
        
        .new-card-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%;
            max-width: 800px;
            padding: 15px;
        }
        
        .new-card {
            width: 150px;
            height: 225px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 8px;
            position: relative;
            transform-style: preserve-3d;
            cursor: pointer;
            border: 1px solid rgba(240, 164, 0, 0.2);
        }
        
        @media (max-width: 480px) {
            .new-card {
                width: 130px;
                height: 195px;
            }
        }
        
        .new-card.flipped {
            transform: rotateY(180deg);
        }
        
        .rarity-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            opacity: 0.3;
            border-radius: 8px;
        }
        
        .common-effect { background: radial-gradient(circle, var(--common) 0%, transparent 70%); }
        .rare-effect { background: radial-gradient(circle, var(--rare) 0%, transparent 70%); }
        .epic-effect { background: radial-gradient(circle, var(--epic) 0%, transparent 70%); }
        .legendary-effect { 
            background: radial-gradient(circle, var(--legendary) 0%, transparent 70%);
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { opacity: 0.3; }
            to { opacity: 0.7; }
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            font-size: clamp(1rem, 5vw, 1.5rem);
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #f0a400;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes flipIn {
            0% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }
        
        .new-card {
            animation: flipIn 0.6s ease-out;
        }
        
        /* 手机横屏适配 */
        @media (orientation: landscape) and (max-height: 500px) {
            .pack {
                max-width: 200px;
                padding: 10px;
            }
            
            .card, .new-card {
                width: 100px;
                height: 150px;
            }
            
            .card-image {
                height: 100px;
            }
        }
        
        /* 卡片信息展示样式 */
        .pack-card-examples {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .pack-card-example {
            width: 100px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .pack-card-image {
            width: 80px;
            height: 120px;
            margin: 0 auto 5px;
            border-radius: 5px;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(240, 164, 0, 0.2);
        }
        
        .pack-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .pack-card-name {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .pack-card-rarity {
            font-size: 10px;
        }
        
        /* 图鉴样式 */
        .handbook-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .handbook-card {
            width: 100px;
            height: 150px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
            border: 1px solid rgba(240, 164, 0, 0.2);
        }
        
        .handbook-card:hover {
            transform: scale(1.05);
        }
        
        .handbook-card.uncollected {
            filter: grayscale(100%);
            opacity: 0.7;
        }
        
        .handbook-card-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            object-position: center top;
            border-bottom: 1px solid rgba(240, 164, 0, 0.2);
        }
        
        .handbook-card-info {
            padding: 5px;
            text-align: center;
        }
        
        .handbook-card-name {
            font-weight: bold;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .handbook-card-type {
            font-size: 10px;
            color: #aaa;
        }
        
        .handbook-card-rarity {
            font-size: 10px;
            margin-top: 3px;
        }
        
        /* 批量出售样式 */
        .bulk-sell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .bulk-sell-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .bulk-sell-actions {
            display: flex;
            gap: 10px;
        }
        
        .bulk-sell-options {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .bulk-sell-option {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .bulk-sell-option.selected {
            background: rgba(255,0,0,0.3);
            border-color: #ff0000;
        }
        
        .bulk-sell-option.common.selected {
            background: rgba(160,160,160,0.3);
            border-color: var(--common);
        }
        
        .bulk-sell-option.rare.selected {
            background: rgba(0,112,255,0.3);
            border-color: var(--rare);
        }
        
        .bulk-sell-option.epic.selected {
            background: rgba(163,53,238,0.3);
            border-color: var(--epic);
        }
        
        .bulk-sell-option.legendary.selected {
            background: rgba(255,128,0,0.3);
            border-color: var(--legendary);
        }
        
        /* 选项卡样式 */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .tab {
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin: 0 5px;
            transition: background 0.2s;
        }
        
        .tab:hover {
            background: rgba(240, 164, 0, 0.1);
        }
        
        .tab.active {
            background: rgba(240, 164, 0, 0.1);
            border-bottom: 2px solid #f0a400;
        }
        
        /* 响应式调整 */
        @media (max-width: 600px) {
            .handbook-card {
                width: 80px;
                height: 130px;
            }
            
            .handbook-card-image {
                height: 80px;
            }
            
            .handbook-card-name {
                font-size: 10px;
            }
            
            .bulk-sell-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .bulk-sell-controls {
                flex-direction: column;
            }
            
            .bulk-sell-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* 登录/注册模态框样式 */
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(26, 26, 46, 0.9);
            border-radius: 10px;
            position: relative;
            border: 1px solid rgba(240, 164, 0, 0.3);
        }
        
        .auth-form h2 {
            margin-bottom: 20px;
            color: #f0a400;
        }
        
        .auth-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #333;
            background: rgba(42, 42, 62, 0.8);
            color: #fff;
            transition: border 0.2s;
        }
        
        .auth-form input:focus {
            border-color: #f0a400;
            outline: none;
        }
        
        .auth-form button {
            width: 100%;
            margin-top: 10px;
        }
        
        .auth-switch {
            margin-top: 15px;
            font-size: 14px;
            color: #ccc;
        }
        
        .auth-switch a {
            color: #f0a400;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
        }
        
        /* 用户信息样式 - 更新 */
        .user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid rgba(240, 164, 0, 0.2);
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid rgba(240, 164, 0, 0.3);
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-name {
            font-size: 14px;
            color: #f0a400;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
            transition: color 0.2s;
        }
        
        .logout-btn:hover {
            color: #fff;
        }

        /* 登录按钮样式 */
        .auth-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        
        .auth-btn {
            background: linear-gradient(135deg, #f0a400, #ff6b00);
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .auth-btn:hover {
            transform: scale(1.05);
        }

        /* 表单加载指示器 */
        .form-loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
        }

        /* 游客提示 */
        .guest-notice {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
        
        /* 错误提示 */
        .error-message {
            color: #ff4d4d;
            margin-bottom: 15px;
            font-size: 14px;
            min-height: 20px;
        }
        
        /* 进度条 */
        .progress-container {
            width: 100%;
            background: #333;
            border-radius: 5px;
            margin: 10px 0;
            height: 10px;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(135deg, #f0a400, #ff6b00);
            width: 0%;
            transition: width 0.3s;
        }
        
        /* 每日奖励 */
        .daily-reward {
            position: absolute;
            top: 10px;
            left: 10px;
        }
        
        /* 动画效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* 图片放大模态框 */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
        }
        
        .image-modal-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        /* 空状态提示 */
        .empty-state {
            width: 100%;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin: 20px 0;
            color: #aaa;
        }
        
        /* 英雄属性样式 */
        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 5px;
            font-size: 10px;
            text-align: left;
            padding: 0 5px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
        }
        
        .stat-name {
            color: #aaa;
            margin-right: 3px;
            white-space: nowrap;
        }
        
        .stat-value {
            font-weight: bold;
            color: #fff;
        }
        
        /* 成就系统样式 */
        .achievements-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .achievement {
            width: 120px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(240, 164, 0, 0.3);
            position: relative;
        }
        
        .achievement.locked {
            filter: grayscale(80%);
            opacity: 0.7;
        }
        
        .achievement-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 5px;
            background: rgba(240, 164, 0, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .achievement-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        .achievement-desc {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .achievement-progress {
            height: 3px;
            background: #333;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: #f0a400;
            width: 0%;
        }
        
        /* 战斗系统样式 */
        .battle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .battle-cards {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .battle-card {
            width: 160px;
            height: 240px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(240, 164, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        
        .battle-card-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid rgba(240, 164, 0, 0.3);
            margin-bottom: 10px;
        }
        
        .battle-card-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .battle-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }
        
        .battle-stat {
            text-align: center;
        }
        
        .battle-stat-name {
            font-size: 10px;
            color: #aaa;
        }
        
        .battle-stat-value {
            font-weight: bold;
            font-size: 14px;
        }
        
        .battle-result {
            margin-top: 20px;
            font-size: 18px;
            color: #f0a400;
            text-align: center;
        }
        
        /* 导航菜单样式 */
        .nav-menu {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-item {
            padding: 8px 15px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(240, 164, 0, 0.3);
            font-size: 14px;
        }
        
        .nav-item:hover {
            background: rgba(240, 164, 0, 0.2);
        }
        
        .nav-item.active {
            background: rgba(240, 164, 0, 0.3);
        }
    </style>
    <!-- 引入英雄联盟字体 -->
    <link href="https://fonts.cdnfonts.com/css/beaufort-for-lol" rel="stylesheet">
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div id="loading-text">正在初始化游戏...</div>
    </div>
    
    <div class="container">
        <header>
            <!-- 更新用户信息区域 -->
            <div class="user-info" id="user-info" style="display: none;">
                <div class="user-avatar">
                    <img id="user-avatar" src="https://ddragon.leagueoflegends.com/cdn/13.1.0/img/profileicon/0.png" alt="头像">
                </div>
                <div>
                    <div class="user-name" id="user-name">用户名</div>
                    <button class="logout-btn" id="logout-btn">退出</button>
                </div>
            </div>
            
            <!-- 添加登录按钮 -->
            <div class="auth-buttons" id="auth-buttons">
                <button class="auth-btn" id="login-btn">登录/注册</button>
            </div>
            
            <div class="daily-reward">
                <button class="btn btn-success btn-sm" id="daily-reward-btn">每日奖励</button>
            </div>
            <h1>英雄联盟卡牌收藏家</h1>
            <div class="currency">金币: <span id="gold">1000</span></div>
            <div class="guest-notice" id="guest-notice" style="display: none;">游客模式 - 数据不会保存</div>
        </header>
        
        <!-- 导航菜单 -->
        <div class="nav-menu">
            <div class="nav-item active" data-section="shop">卡包商店</div>
            <div class="nav-item" data-section="collection">我的卡牌</div>
            <div class="nav-item" data-section="handbook">图鉴</div>
            <div class="nav-item" data-section="battle">卡牌对战</div>
            <div class="nav-item" data-section="achievements">成就</div>
        </div>
        
        <!-- 卡包商店部分 -->
        <div class="game-section" id="shop-section">
            <h2>选择卡包</h2>
            <div class="packs-section">
                <div class="pack" data-pack-type="basic">
                    <button class="pack-info-btn">i</button>
                    <img src="https://ddragon.leagueoflegends.com/cdn/img/champion/tiles/Ashe_0.jpg" alt="基础卡包">
                    <h3>基础卡包</h3>
                    <p>5张随机卡牌</p>
                    <p>包含英雄和普通皮肤</p>
                    <p class="pack-price">200金币</p>
                    <button class="btn open-pack-btn" data-pack-type="basic">购买并开启</button>
                </div>
                <div class="pack" data-pack-type="premium">
                    <button class="pack-info-btn">i</button>
                    <img src="https://ddragon.leagueoflegends.com/cdn/img/champion/tiles/Lux_0.jpg" alt="高级卡包">
                    <h3>高级卡包</h3>
                    <p>5张随机卡牌</p>
                    <p>包含稀有和史诗皮肤</p>
                    <p class="pack-price">500金币</p>
                    <button class="btn open-pack-btn" data-pack-type="premium">购买并开启</button>
                </div>
                <div class="pack" data-pack-type="luxury">
                    <button class="pack-info-btn">i</button>
                    <img src="https://ddragon.leagueoflegends.com/cdn/img/champion/tiles/Ahri_0.jpg" alt="豪华卡包">
                    <h3>豪华卡包</h3>
                    <p>5张随机卡牌</p>
                    <p>包含传说和终极皮肤</p>
                    <p class="pack-price">1000金币</p>
                    <button class="btn open-pack-btn" data-pack-type="luxury">购买并开启</button>
                </div>
            </div>
        </div>
        
        <!-- 我的卡牌部分 -->
        <div class="game-section" id="collection-section" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <h2>你的收藏</h2>
                    <span id="collection-count">(0)</span>
                </div>
                <div>
                    <button class="btn btn-danger btn-sm" id="bulk-sell-btn">批量出售</button>
                </div>
            </div>
            <div class="cards-container" id="cards-container">
                <!-- 卡片将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 图鉴部分 -->
        <div class="game-section" id="handbook-section" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <h2>图鉴</h2>
                </div>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="champions">英雄</div>
                <div class="tab" data-tab="skins">皮肤</div>
            </div>
            <div class="handbook-container" id="handbook-content">
                <!-- 图鉴内容将在这里动态生成 -->
            </div>
        </div>
        
        <!-- 卡牌对战部分 -->
        <div class="game-section" id="battle-section" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <h2>卡牌对战</h2>
                </div>
            </div>
            <div class="battle-container">
                <div class="battle-cards">
                    <div class="battle-card" id="player-card">
                        <div>你的卡牌</div>
                        <img class="battle-card-image" id="player-card-image" src="https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_0.jpg">
                        <div class="battle-card-name" id="player-card-name">选择卡牌</div>
                        <div class="battle-card-stats">
                            <div class="battle-stat">
                                <div class="battle-stat-name">攻击力</div>
                                <div class="battle-stat-value" id="player-attack">0</div>
                            </div>
                            <div class="battle-stat">
                                <div class="battle-stat-name">防御力</div>
                                <div class="battle-stat-value" id="player-defense">0</div>
                            </div>
                            <div class="battle-stat">
                                <div class="battle-stat-name">生命值</div>
                                <div class="battle-stat-value" id="player-health">0</div>
                            </div>
                            <div class="battle-stat">
                                <div class="battle-stat-name">法力值</div>
                                <div class="battle-stat-value" id="player-mana">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="battle-card" id="opponent-card">
                        <div>对手卡牌</div>
                        <img class="battle-card-image" id="opponent-card-image" src="https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_0.jpg">
                        <div class="battle-card-name" id="opponent-card-name">随机对手</div>
                        <div class="battle-card-stats">
                            <div class="battle-stat">
                                <div class="battle-stat-name">攻击力</div>
                                <div class="battle-stat-value" id="opponent-attack">0</div>
                            </div>
                            <div class="battle-stat">
                                <div class="battle-stat-name">防御力</div>
                                <div class="battle-stat-value" id="opponent-defense">0</div>
                            </div>
                            <div class="battle-stat">
                                <div class="battle-stat-name">生命值</div>
                                <div class="battle-stat-value" id="opponent-health">0</div>
                            </div>
                            <div class="battle-stat">
                                <div class="battle-stat-name">法力值</div>
                                <div class="battle-stat-value" id="opponent-mana">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="battle-result" id="battle-result"></div>
                <button class="btn" id="battle-btn" disabled>开始对战</button>
                <div class="cards-container" id="battle-select-container">
                    <!-- 对战选择卡牌将在这里动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 成就系统部分 -->
        <div class="game-section" id="achievements-section" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <h2>成就系统</h2>
                </div>
            </div>
            <div class="achievements-container" id="achievements-container">
                <!-- 成就将在这里动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 卡包信息模态框 -->
    <div class="modal" id="pack-info-modal">
        <div class="modal-content">
            <button class="close-modal">×</button>
            <h2 id="pack-info-title">卡包信息</h2>
            <div id="pack-info-content">
                <!-- 卡包信息将在这里动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 新卡片展示模态框 -->
    <div class="new-card-modal" id="new-card-modal">
        <div>
            <h2>你获得了以下卡牌！</h2>
            <div class="new-card-container" id="new-card-container">
                <!-- 新卡片将在这里动态生成 -->
            </div>
            <button class="btn close-new-cards-btn">确认</button>
        </div>
    </div>
    
    <!-- 批量出售模态框 -->
    <div class="modal" id="bulk-sell-modal">
        <div class="modal-content">
            <button class="close-modal">×</button>
            <div class="bulk-sell-header">
                <h2>批量出售</h2>
                <div class="bulk-sell-actions">
                    <button class="btn btn-secondary btn-sm" id="select-all-btn">全选</button>
                    <button class="btn btn-secondary btn-sm" id="deselect-all-btn">取消全选</button>
                    <button class="btn btn-danger btn-sm" id="confirm-bulk-sell">出售选中</button>
                </div>
            </div>
            
            <div class="bulk-sell-controls">
                <div class="bulk-sell-options">
                    <div class="bulk-sell-option common" data-rarity="common">普通</div>
                    <div class="bulk-sell-option rare" data-rarity="rare">稀有</div>
                    <div class="bulk-sell-option epic" data-rarity="epic">史诗</div>
                    <div class="bulk-sell-option legendary" data-rarity="legendary">传说</div>
                </div>
            </div>
            
            <div class="cards-container" id="bulk-sell-container">
                <!-- 批量出售的卡片将在这里动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 登录/注册模态框 - 更新 -->
    <div class="modal" id="auth-modal">
        <div class="modal-content" style="max-width: 400px;">
            <button class="close-modal">×</button>
            <div class="auth-form" id="login-form">
                <div class="form-loading" id="login-loading">
                    <div>正在登录...</div>
                </div>
                <h2>登录</h2>
                <div class="error-message" id="login-error"></div>
                <input type="email" id="login-email" placeholder="邮箱">
                <input type="password" id="login-password" placeholder="密码">
                <button class="btn" id="login-submit">登录</button>
                <div class="auth-switch">还没有账号？ <a id="switch-to-register">注册</a></div>
            </div>
            
            <div class="auth-form" id="register-form" style="display: none;">
                <div class="form-loading" id="register-loading">
                    <div>正在注册...</div>
                </div>
                <h2>注册</h2>
                <div class="error-message" id="register-error"></div>
                <input type="text" id="register-name" placeholder="用户名">
                <input type="email" id="register-email" placeholder="邮箱">
                <input type="password" id="register-password" placeholder="密码">
                <input type="password" id="register-confirm" placeholder="确认密码">
                <button class="btn" id="register-submit">注册</button>
                <div class="auth-switch">已有账号？ <a id="switch-to-login">登录</a></div>
            </div>
        </div>
    </div>
    
    <!-- 每日奖励模态框 -->
    <div class="modal" id="daily-reward-modal">
        <div class="modal-content">
            <button class="close-modal">×</button>
            <h2>每日奖励</h2>
            <div id="daily-reward-content">
                <p>连续登录可获得更多奖励！</p>
                <div class="progress-container">
                    <div class="progress-bar" id="daily-progress"></div>
                </div>
                <div id="daily-reward-info"></div>
                <button class="btn" id="claim-daily-reward">领取奖励</button>
            </div>
        </div>
    </div>
    
    <!-- 图片放大模态框 -->
    <div class="image-modal" id="image-modal">
        <div class="image-modal-content">
            <img id="modal-image" src="" alt="放大图片">
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // 全局变量
        let gold = 1000;
        let collection = [];
        let allChampions = [];
        let allSkins = [];
        let championStats = {}; // 存储英雄基础属性
        let collectedCards = {
            champions: new Set(),
            skins: new Set()
        };
        const CURRENT_VERSION = '14.14.1';
        let isGuest = true;
        let userData = null;
        let dailyRewardClaimed = false;
        let consecutiveDays = 0;
        let lastClaimDate = null;
        let achievements = [
            { id: 'first_pack', name: '初次开包', desc: '开启第一个卡包', completed: false, reward: 100 },
            { id: 'collect_10', name: '初级收藏家', desc: '收集10张不同的卡牌', completed: false, reward: 200, progress: 0, target: 10 },
            { id: 'collect_50', name: '中级收藏家', desc: '收集50张不同的卡牌', completed: false, reward: 500, progress: 0, target: 50 },
            { id: 'collect_all', name: '终极收藏家', desc: '收集所有卡牌', completed: false, reward: 1000, progress: 0, target: 0 },
            { id: 'sell_10', name: '初级商人', desc: '出售10张卡牌', completed: false, reward: 150, progress: 0, target: 10 },
            { id: 'sell_50', name: '中级商人', desc: '出售50张卡牌', completed: false, reward: 300, progress: 0, target: 50 },
            { id: 'sell_100', name: '终极商人', desc: '出售100张卡牌', completed: false, reward: 500, progress: 0, target: 100 },
            { id: 'win_5', name: '初级战士', desc: '赢得5场对战', completed: false, reward: 200, progress: 0, target: 5 },
            { id: 'win_20', name: '中级战士', desc: '赢得20场对战', completed: false, reward: 500, progress: 0, target: 20 },
            { id: 'win_50', name: '终极战士', desc: '赢得50场对战', completed: false, reward: 1000, progress: 0, target: 50 },
            { id: 'daily_7', name: '一周坚持', desc: '连续登录7天', completed: false, reward: 300, progress: 0, target: 7 },
            { id: 'daily_30', name: '一月坚持', desc: '连续登录30天', completed: false, reward: 1000, progress: 0, target: 30 }
        ];
        let battleStats = {
            wins: 0,
            losses: 0
        };
        let selectedBattleCard = null;
        
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCRnja6I3WcZd_6k70LIiiIduJ8Ktxy8RA",
            authDomain: "lolcardcollector.firebaseapp.com",
            projectId: "lolcardcollector",
            storageBucket: "lolcardcollector.firebasestorage.app",
            messagingSenderId: "779295819096",
            appId: "1:779295819096:web:cc1073632e83aa2d4fd12d",
            measurementId: "G-0LN387GEP5"
        };
        
        // 初始化Firebase应用
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // 初始化函数
        async function init() {
            showLoading(true);
            try {
                // 先加载游戏数据
                try {
                    await loadAllChampions();
                    await loadAllSkins();
                    await loadChampionStats();
                } catch (apiError) {
                    console.warn('API加载失败，使用模拟数据:', apiError);
                    useMockData();
                }
                
                // 设置收集所有卡牌的目标
                achievements[3].target = allChampions.length + allSkins.length;
                
                // 然后初始化认证监听
                initAuthStateListener();
                
                // 加载本地存储的数据（游客模式）
                loadLocalData();
                
                updateGoldDisplay();
                updateCollectionCount();
                renderAchievements();
                
                // 添加事件监听器
                setupEventListeners();
                
            } catch (error) {
                console.error('初始化失败:', error);
                showLoading(false, '初始化失败: ' + error.message);
                setTimeout(() => {
                    showLoading(false);
                    alert('游戏初始化失败，请刷新页面重试\n错误信息: ' + error.message);
                }, 2000);
            } finally {
                setTimeout(() => {
                    showLoading(false);
                }, 500);
            }
        }
        
        // 初始化认证状态监听 - 优化版本
        function initAuthStateListener() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // 用户已登录
                    isGuest = false;
                    userData = user;
                    document.getElementById('auth-buttons').style.display = 'none';
                    document.getElementById('user-info').style.display = 'flex';
                    document.getElementById('guest-notice').style.display = 'none';
                    document.getElementById('user-name').textContent = user.displayName || user.email;
                    
                    try {
                        // 显示加载状态
                        showLoading(true, '加载用户数据...');
                        
                        // 加载用户数据
                        await loadUserData();
                        
                        // 更新UI
                        updateGoldDisplay();
                        renderCollection();
                        updateCollectionCount();
                        renderAchievements();
                        
                        // 检查每日奖励
                        checkDailyReward();
                    } catch (error) {
                        console.error('加载用户数据失败:', error);
                        alert('加载用户数据失败，请刷新页面重试');
                    } finally {
                        showLoading(false);
                    }
                } else {
                    // 用户未登录，游客模式
                    isGuest = true;
                    userData = null;
                    document.getElementById('auth-buttons').style.display = 'flex';
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('guest-notice').style.display = 'block';
                }
            });
        }
        
        // 加载用户数据
        async function loadUserData() {
            if (isGuest) return;
            
            try {
                const userDoc = await db.collection('users').doc(userData.uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    gold = data.gold || 1000;
                    collection = data.collection || [];
                    collectedCards = data.collectedCards || {
                        champions: new Set(),
                        skins: new Set()
                    };
                    
                    // 转换Set对象
                    if (data.collectedCards) {
                        collectedCards.champions = new Set(data.collectedCards.champions);
                        collectedCards.skins = new Set(data.collectedCards.skins);
                    }
                    
                    // 每日奖励数据
                    dailyRewardClaimed = data.dailyRewardClaimed || false;
                    consecutiveDays = data.consecutiveDays || 0;
                    lastClaimDate = data.lastClaimDate ? new Date(data.lastClaimDate) : null;
                    
                    // 成就数据
                    if (data.achievements) {
                        achievements = data.achievements;
                    }
                    
                    // 对战数据
                    if (data.battleStats) {
                        battleStats = data.battleStats;
                    }
                } else {
                    // 新用户，初始化数据
                    await saveUserData();
                }
            } catch (error) {
                console.error('加载用户数据失败:', error);
                throw error;
            }
        }
        
        // 保存用户数据
        async function saveUserData() {
            if (isGuest) {
                saveLocalData();
                return;
            }
            
            try {
                await db.collection('users').doc(userData.uid).set({
                    uid: userData.uid,
                    displayName: userData.displayName || userData.email,
                    email: userData.email,
                    gold: gold,
                    collection: collection,
                    collectedCards: {
                        champions: Array.from(collectedCards.champions),
                        skins: Array.from(collectedCards.skins)
                    },
                    dailyRewardClaimed: dailyRewardClaimed,
                    consecutiveDays: consecutiveDays,
                    lastClaimDate: lastClaimDate,
                    achievements: achievements,
                    battleStats: battleStats,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('保存用户数据失败:', error);
                throw error;
            }
        }
        
        // 使用模拟数据
        function useMockData() {
            allChampions = [
                { id: "Ashe", name: "艾希", title: "寒冰射手" },
                { id: "Garen", name: "盖伦", title: "德玛西亚之力" },
                { id: "Lux", name: "拉克丝", title: "光辉女郎" },
                { id: "Ezreal", name: "伊泽瑞尔", title: "探险家" },
                { id: "Ahri", name: "阿狸", title: "九尾妖狐" }
            ];
            
            allSkins = [
                { id: 1000, num: 1, name: "女皇艾希", championId: "Ashe", championName: "艾希", championTitle: "寒冰射手", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ashe.png" },
                { id: 1001, num: 2, name: "极地女神艾希", championId: "Ashe", championName: "艾希", championTitle: "寒冰射手", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ashe.png" },
                { id: 1002, num: 3, name: "冠军艾希", championId: "Ashe", championName: "艾希", championTitle: "寒冰射手", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ashe.png" },
                { id: 2000, num: 1, name: "钢铁军团盖伦", championId: "Garen", championName: "盖伦", championTitle: "德玛西亚之力", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Garen.png" },
                { id: 2001, num: 2, name: "战神盖伦", championId: "Garen", championName: "盖伦", championTitle: "德玛西亚之力", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Garen.png" },
                { id: 2002, num: 3, name: "神王盖伦", championId: "Garen", championName: "盖伦", championTitle: "德玛西亚之力", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Garen.png" },
                { id: 4000, num: 1, name: "奥术光辉拉克丝", championId: "Lux", championName: "拉克丝", championTitle: "光辉女郎", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Lux.png" },
                { id: 4001, num: 2, name: "星之守护者拉克丝", championId: "Lux", championName: "拉克丝", championTitle: "光辉女郎", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Lux.png" },
                { id: 4002, num: 3, name: "元素女皇拉克丝", championId: "Lux", championName: "拉克丝", championTitle: "光辉女郎", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Lux.png" },
                { id: 5000, num: 1, name: "足球先生伊泽瑞尔", championId: "Ezreal", championName: "伊泽瑞尔", championTitle: "探险家", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ezreal.png" },
                { id: 5001, num: 2, name: "未来战士伊泽瑞尔", championId: "Ezreal", championName: "伊泽瑞尔", championTitle: "探险家", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ezreal.png" },
                { id: 5002, num: 3, name: "星之守护者伊泽瑞尔", championId: "Ezreal", championName: "伊泽瑞尔", championTitle: "探险家", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ezreal.png" },
                { id: 9000, num: 1, name: "高丽风情阿狸", championId: "Ahri", championName: "阿狸", championTitle: "九尾妖狐", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_1.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ahri.png" },
                { id: 9001, num: 2, name: "星之守护者阿狸", championId: "Ahri", championName: "阿狸", championTitle: "九尾妖狐", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_2.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ahri.png" },
                { id: 9002, num: 3, name: "偶像歌手阿狸", championId: "Ahri", championName: "阿狸", championTitle: "九尾妖狐", loadingImg: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_3.jpg", portraitImg: "https://ddragon.leagueoflegends.com/cdn/14.14.1/img/champion/Ahri.png" }
            ];
            
            // 模拟英雄属性
            championStats = {
                "Ashe": { attack: 56, defense: 21, health: 570, mana: 280 },
                "Garen": { attack: 66, defense: 36, health: 620, mana: 0 },
                "Lux": { attack: 54, defense: 18, health: 490, mana: 480 },
                "Ezreal": { attack: 60, defense: 22, health: 530, mana: 375 },
                "Ahri": { attack: 53, defense: 20, health: 500, mana: 418 }
            };
        }
        
        // 加载英雄基础属性
        async function loadChampionStats() {
            const response = await fetch(`https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/data/zh_CN/champion.json`);
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Expected JSON but got: ${text.substring(0, 100)}...`);
            }
            
            const data = await response.json();
            
            // 提取英雄基础属性
            Object.values(data.data).forEach(champ => {
                championStats[champ.id] = {
                    attack: champ.stats.attackdamage,
                    defense: champ.stats.armor,
                    health: champ.stats.hp,
                    mana: champ.stats.mp
                };
            });
        }
        
        // 加载本地存储的数据
        function loadLocalData() {
            const savedData = localStorage.getItem('lolCardCollector');
            if (savedData) {
                const data = JSON.parse(savedData);
                gold = data.gold || 1000;
                collection = data.collection || [];
                collectedCards = data.collectedCards || {
                    champions: new Set(),
                    skins: new Set()
                };
                
                // 转换Set对象
                if (data.collectedCards) {
                    collectedCards.champions = new Set(data.collectedCards.champions);
                    collectedCards.skins = new Set(data.collectedCards.skins);
                }
                
                // 成就数据
                if (data.achievements) {
                    achievements = data.achievements;
                }
                
                // 对战数据
                if (data.battleStats) {
                    battleStats = data.battleStats;
                }
            }
        }
        
        // 保存数据到本地存储
        function saveLocalData() {
            const data = {
                gold,
                collection,
                collectedCards: {
                    champions: Array.from(collectedCards.champions),
                    skins: Array.from(collectedCards.skins)
                },
                achievements,
                battleStats
            };
            localStorage.setItem('lolCardCollector', JSON.stringify(data));
        }
        
        // 加载所有英雄数据
        async function loadAllChampions() {
            const response = await fetch(`https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/data/zh_CN/champion.json`);
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Expected JSON but got: ${text.substring(0, 100)}...`);
            }
            
            const data = await response.json();
            
            allChampions = Object.values(data.data).map(champ => ({
                id: champ.id,
                key: champ.key,
                name: champ.name,
                title: champ.title
            }));
        }
        
        // 加载所有皮肤数据
        async function loadAllSkins() {
            allSkins = [];
            
            // 优化加载速度，只加载前20个英雄的皮肤
            const championsToLoad = allChampions.slice(0, 20);
            
            for (const champ of championsToLoad) {
                try {
                    const response = await fetch(`https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/data/zh_CN/champion/${champ.id}.json`);
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.warn(`英雄 ${champ.name} 的皮肤数据不是JSON格式`);
                        continue;
                    }
                    
                    const data = await response.json();
                    const championData = data.data[champ.id];
                    
                    championData.skins.forEach(skin => {
                        if (skin.num > 0) {
                            allSkins.push({
                                id: skin.id,
                                num: skin.num,
                                name: skin.name,
                                championId: champ.id,
                                championName: champ.name,
                                championTitle: champ.title,
                                loadingImg: `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${champ.id}_${skin.num}.jpg`,
                                portraitImg: `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${champ.id}.png`
                            });
                        }
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 50));
                } catch (error) {
                    console.error(`加载英雄 ${champ.name} 的皮肤数据失败:`, error);
                }
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 开包按钮
            document.querySelectorAll('.open-pack-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const packType = this.getAttribute('data-pack-type');
                    openPack(packType);
                });
            });
            
            // 卡包信息按钮
            document.querySelectorAll('.pack-info-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const packType = this.closest('.pack').getAttribute('data-pack-type');
                    showPackInfo(packType);
                });
            });
            
            // 关闭模态框按钮
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalId = this.closest('.modal').id;
                    closeModal(modalId);
                });
            });
            
            // 关闭新卡片展示按钮
            document.querySelector('.close-new-cards-btn').addEventListener('click', function() {
                closeModal('new-card-modal');
            });
            
            // 使用事件委托处理出售按钮点击事件
            document.getElementById('cards-container').addEventListener('click', function(e) {
                if (e.target.classList.contains('sell-btn')) {
                    const cardIndex = parseInt(e.target.getAttribute('data-index'));
                    sellCard(cardIndex);
                }
            });
            
            // 批量出售按钮
            document.getElementById('bulk-sell-btn').addEventListener('click', function() {
                showBulkSellModal();
            });
            
            // 确认批量出售按钮
            document.getElementById('confirm-bulk-sell').addEventListener('click', function() {
                confirmBulkSell();
            });
            
            // 全选按钮
            document.getElementById('select-all-btn').addEventListener('click', function() {
                selectAllCards(true);
            });
            
            // 取消全选按钮
            document.getElementById('deselect-all-btn').addEventListener('click', function() {
                selectAllCards(false);
            });
            
            // 图鉴选项卡
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.getAttribute('data-tab');
                    switchHandbookTab(tabType);
                });
            });
            
            // 批量出售选项
            document.querySelectorAll('.bulk-sell-option').forEach(option => {
                option.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    filterBulkSellCards();
                });
            });
            
            // 登录/注册按钮
            document.getElementById('login-btn').addEventListener('click', function() {
                showAuthModal('login');
            });
            
            // 退出登录按钮
            document.getElementById('logout-btn').addEventListener('click', function() {
                logout();
            });
            
            // 登录/注册表单切换
            document.getElementById('switch-to-register').addEventListener('click', function() {
                showAuthModal('register');
            });
            
            document.getElementById('switch-to-login').addEventListener('click', function() {
                showAuthModal('login');
            });
            
            // 登录提交
            document.getElementById('login-submit').addEventListener('click', function() {
                login();
            });
            
            // 注册提交
            document.getElementById('register-submit').addEventListener('click', function() {
                register();
            });
            
            // 每日奖励按钮
            document.getElementById('daily-reward-btn').addEventListener('click', function() {
                showDailyRewardModal();
            });
            
            // 领取每日奖励
            document.getElementById('claim-daily-reward').addEventListener('click', function() {
                claimDailyReward();
            });
            
            // 图片放大功能
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('handbook-card-image') || 
                    e.target.classList.contains('card-image')) {
                    const imgSrc = e.target.getAttribute('src');
                    showImageModal(imgSrc);
                }
            });
            
            // 关闭图片放大模态框
            document.getElementById('image-modal').addEventListener('click', function() {
                closeModal('image-modal');
            });
            
            // 导航菜单
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
            
            // 对战按钮
            document.getElementById('battle-btn').addEventListener('click', function() {
                startBattle();
            });
        }
        
        // 显示/隐藏加载指示器
        function showLoading(show, message = '正在初始化游戏...') {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = show ? 'flex' : 'none';
            document.getElementById('loading-text').textContent = message;
        }
        
        // 显示表单加载状态
        function showFormLoading(formType, show) {
            document.getElementById(`${formType}-loading`).style.display = show ? 'flex' : 'none';
        }
        
        // 更新金币显示
        function updateGoldDisplay() {
            document.getElementById('gold').textContent = gold;
            document.querySelectorAll('.open-pack-btn').forEach(btn => {
                const packType = btn.getAttribute('data-pack-type');
                const packPrice = getPackPrice(packType);
                btn.disabled = gold < packPrice;
            });
            
            // 根据金币数量调整按钮样式
            document.querySelectorAll('.open-pack-btn').forEach(btn => {
                const packType = btn.getAttribute('data-pack-type');
                const packPrice = getPackPrice(packType);
                
                if (gold >= packPrice * 3) {
                    btn.classList.add('pulse');
                } else {
                    btn.classList.remove('pulse');
                }
            });
            
            saveUserData();
        }
        
        // 获取卡包价格
        function getPackPrice(packType) {
            switch(packType) {
                case 'basic': return 200;
                case 'premium': return 500;
                case 'luxury': return 1000;
                default: return 0;
            }
        }
        
        // 更新收藏数量显示
        function updateCollectionCount() {
            const count = collection.length;
            document.getElementById('collection-count').textContent = `(${count})`;
            
            // 更新成就进度
            updateAchievementProgress('collect_10', collectedCards.champions.size + collectedCards.skins.size);
            updateAchievementProgress('collect_50', collectedCards.champions.size + collectedCards.skins.size);
            updateAchievementProgress('collect_all', collectedCards.champions.size + collectedCards.skins.size);
            
            saveUserData();
        }
        
        // 渲染收藏
        function renderCollection() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            if (collection.length === 0) {
                container.innerHTML = '<div class="empty-state">你还没有任何卡片，快去开包吧！</div>';
                return;
            }
            
            collection.forEach((card, index) => {
                const cardElement = createCardElement(card, index);
                container.appendChild(cardElement);
            });
        }
        
        // 创建卡片元素
        function createCardElement(card, index) {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            
            let imageUrl, cardTitle, cardName;
            if (card.type === 'skin') {
                imageUrl = card.skin.loadingImg;
                cardTitle = `${card.skin.name}`;
                cardName = card.skin.name;
            } else {
                imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${card.championId}_0.jpg`;
                cardTitle = card.title;
                cardName = card.name;
            }
            
            const cardValue = calculateCardValue(card);
            const stats = card.type === 'skin' ? 
                getSkinStats(card.skin.championId, card.rarity) : 
                getChampionStats(card.championId, card.rarity);
            
            cardElement.innerHTML = `
                <div class="card-face card-front">
                    <img class="card-image" src="${imageUrl}" alt="${cardName}" 
                         onerror="this.src='${card.type === 'skin' ? card.skin.portraitImg : `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${card.championId}.png`}'">
                    <div class="card-info">
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-name">攻击:</span>
                                <span class="stat-value">${stats.attack}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">防御:</span>
                                <span class="stat-value">${stats.defense}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">生命:</span>
                                <span class="stat-value">${stats.health}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">法力:</span>
                                <span class="stat-value">${stats.mana}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-face card-back">
                    <div>
                        <h3>${cardName}</h3>
                        <p>${cardTitle}</p>
                        ${card.type === 'skin' ? `<p>英雄: ${card.skin.championName}</p>` : ''}
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                    <div class="card-value">
                        <p>价值: ${cardValue}金币</p>
                        <button class="sell-btn" data-index="${index}">出售</button>
                    </div>
                </div>
            `;
            
            cardElement.addEventListener('click', function(e) {
                if (!e.target.classList.contains('sell-btn')) {
                    this.classList.toggle('flipped');
                }
            });
            
            return cardElement;
        }
        
        // 获取英雄属性
        function getChampionStats(championId, rarity) {
            const baseStats = championStats[championId] || { 
                attack: 50, 
                defense: 20, 
                health: 500, 
                mana: 300 
            };
            
            // 根据稀有度调整属性
            let multiplier = 1;
            switch(rarity) {
                case 'common': multiplier = 1; break;
                case 'rare': multiplier = 1.2; break;
                case 'epic': multiplier = 1.5; break;
                case 'legendary': multiplier = 2; break;
            }
            
            return {
                attack: Math.round(baseStats.attack * multiplier),
                defense: Math.round(baseStats.defense * multiplier),
                health: Math.round(baseStats.health * multiplier),
                mana: Math.round(baseStats.mana * multiplier)
            };
        }
        
        // 获取皮肤属性（基于英雄属性）
        function getSkinStats(championId, rarity) {
            const baseStats = championStats[championId] || { 
                attack: 50, 
                defense: 20, 
                health: 500, 
                mana: 300 
            };
            
            // 皮肤属性比英雄高一些
            let multiplier = 1.2;
            switch(rarity) {
                case 'common': multiplier = 1.2; break;
                case 'rare': multiplier = 1.5; break;
                case 'epic': multiplier = 1.8; break;
                case 'legendary': multiplier = 2.2; break;
            }
            
            return {
                attack: Math.round(baseStats.attack * multiplier),
                defense: Math.round(baseStats.defense * multiplier),
                health: Math.round(baseStats.health * multiplier),
                mana: Math.round(baseStats.mana * multiplier)
            };
        }
        
        // 创建新卡片元素（用于展示）
        function createNewCardElement(card) {
            const cardElement = document.createElement('div');
            cardElement.className = 'new-card';
            
            let imageUrl, cardTitle, cardName;
            if (card.type === 'skin') {
                imageUrl = card.skin.loadingImg;
                cardTitle = `${card.skin.name}`;
                cardName = card.skin.name;
            } else {
                imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${card.championId}_0.jpg`;
                cardTitle = card.title;
                cardName = card.name;
            }
            
            const cardValue = calculateCardValue(card);
            const stats = card.type === 'skin' ? 
                getSkinStats(card.skin.championId, card.rarity) : 
                getChampionStats(card.championId, card.rarity);
            
            cardElement.innerHTML = `
                <div class="rarity-effects ${card.rarity}-effect"></div>
                <div class="card-face card-front">
                    <img class="card-image" src="${imageUrl}" alt="${cardName}" 
                         onerror="this.src='${card.type === 'skin' ? card.skin.portraitImg : `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${card.championId}.png`}'">
                    <div class="card-info">
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-name">攻击:</span>
                                <span class="stat-value">${stats.attack}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">防御:</span>
                                <span class="stat-value">${stats.defense}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">生命:</span>
                                <span class="stat-value">${stats.health}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">法力:</span>
                                <span class="stat-value">${stats.mana}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-face card-back">
                    <div>
                        <h3>${cardName}</h3>
                        <p>${cardTitle}</p>
                        ${card.type === 'skin' ? `<p>英雄: ${card.skin.championName}</p>` : ''}
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                    <div class="card-value">
                        <p>价值: ${cardValue}金币</p>
                    </div>
                </div>
            `;
            
            cardElement.addEventListener('click', function() {
                this.classList.toggle('flipped');
            });
            
            return cardElement;
        }
        
        // 计算卡片价值
        function calculateCardValue(card) {
            let baseValue = 0;
            
            // 基础价值
            switch(card.rarity) {
                case 'common':
                    baseValue = card.type === 'skin' ? 150 : 75;
                    break;
                case 'rare':
                    baseValue = card.type === 'skin' ? 300 : 200;
                    break;
                case 'epic':
                    baseValue = card.type === 'skin' ? 600 : 400;
                    break;
                case 'legendary':
                    baseValue = card.type === 'skin' ? 1500 : 800;
                    break;
            }
            
            // 随机波动 (±20%)
            const randomFactor = 0.8 + Math.random() * 0.4;
            baseValue = Math.round(baseValue * randomFactor);
            
            // 皮肤价值更高
            if (card.type === 'skin') {
                baseValue = Math.round(baseValue * 1.5);
            }
            
            card.value = baseValue;
            return baseValue;
        }
        
        // 获取稀有度名称
        function getRarityName(rarity) {
            switch(rarity) {
                case 'common': return '普通';
                case 'rare': return '稀有';
                case 'epic': return '史诗';
                case 'legendary': return '传说';
                default: return '普通';
            }
        }
        
        // 开包函数
        async function openPack(packType) {
            const packPrice = getPackPrice(packType);
            
            if (gold < packPrice) {
                alert('金币不足！');
                return;
            }
            
            showLoading(true, '正在开启卡包...');
            
            try {
                gold -= packPrice;
                updateGoldDisplay();
                
                const newCards = [];
                
                for (let i = 0; i < 5; i++) {
                    let rarity;
                    const rand = Math.random();
                    
                    // 根据金币数量调整概率
                    const goldFactor = Math.min(1, gold / 5000); // 0-1之间的值，金币越多越接近1
                    
                    // 基础概率
                    let commonChance, rareChance, epicChance, legendaryChance;
                    
                    // 根据卡包类型调整概率
                    switch(packType) {
                        case 'basic':
                            // 金币越多，稀有卡概率越低
                            commonChance = 0.75 + goldFactor * 0.1;
                            rareChance = 0.2 - goldFactor * 0.08;
                            epicChance = 0.04 - goldFactor * 0.015;
                            legendaryChance = 0.01 - goldFactor * 0.005;
                            break;
                        case 'premium':
                            // 金币越多，稀有卡概率适度降低
                            commonChance = 0.5 + goldFactor * 0.1;
                            rareChance = 0.35 - goldFactor * 0.05;
                            epicChance = 0.13 - goldFactor * 0.04;
                            legendaryChance = 0.02 - goldFactor * 0.01;
                            break;
                        case 'luxury':
                            // 金币越多，稀有卡概率适度降低
                            commonChance = 0.3 + goldFactor * 0.1;
                            rareChance = 0.35 - goldFactor * 0.05;
                            epicChance = 0.25 - goldFactor * 0.04;
                            legendaryChance = 0.1 - goldFactor * 0.01;
                            break;
                    }
                    
                    // 确保概率总和为1
                    const total = commonChance + rareChance + epicChance + legendaryChance;
                    if (total !== 1) {
                        const scale = 1 / total;
                        commonChance *= scale;
                        rareChance *= scale;
                        epicChance *= scale;
                        legendaryChance *= scale;
                    }
                    
                    // 确定稀有度
                    if (rand < commonChance) {
                        rarity = 'common';
                    } else if (rand < commonChance + rareChance) {
                        rarity = 'rare';
                    } else if (rand < commonChance + rareChance + epicChance) {
                        rarity = 'epic';
                    } else {
                        rarity = 'legendary';
                    }
                    
                    // 确定是英雄卡还是皮肤卡
                    const isSkin = (rarity !== 'common' && Math.random() > 0.5) || 
                                  (packType === 'luxury' && Math.random() > 0.3);
                    
                    if (isSkin && allSkins.length > 0) {
                        let eligibleSkins = allSkins;
                        if (packType === 'luxury') {
                            eligibleSkins = allSkins.filter(skin => skin.num >= 5);
                        } else if (packType === 'premium') {
                            eligibleSkins = allSkins.filter(skin => skin.num > 0 && skin.num < 10);
                        }
                        
                        if (eligibleSkins.length > 0) {
                            const randomIndex = Math.floor(Math.random() * eligibleSkins.length);
                            const randomSkin = eligibleSkins[randomIndex];
                            
                            const newCard = {
                                type: 'skin',
                                skin: randomSkin,
                                championId: randomSkin.championId,
                                name: randomSkin.name,
                                title: randomSkin.name,
                                rarity: rarity,
                                obtained: new Date().toLocaleDateString()
                            };
                            
                            // 添加到已收集皮肤
                            collectedCards.skins.add(randomSkin.id);
                            
                            calculateCardValue(newCard);
                            newCards.push(newCard);
                            continue;
                        }
                    }
                    
                    // 英雄卡
                    if (allChampions.length > 0) {
                        const randomIndex = Math.floor(Math.random() * allChampions.length);
                        const randomChampion = allChampions[randomIndex];
                        
                        const newCard = {
                            type: 'champion',
                            championId: randomChampion.id,
                            name: randomChampion.name,
                            title: randomChampion.title,
                            rarity: rarity,
                            obtained: new Date().toLocaleDateString()
                        };
                        
                        // 添加到已收集英雄
                        collectedCards.champions.add(randomChampion.id);
                        
                        calculateCardValue(newCard);
                        newCards.push(newCard);
                    }
                }
                
                collection = collection.concat(newCards);
                updateCollectionCount();
                showNewCards(newCards);
                renderCollection();
                
                // 检查成就
                checkAchievement('first_pack');
                
            } catch (error) {
                console.error('开包出错:', error);
                alert('开包失败，请重试！');
                gold += packPrice;
                updateGoldDisplay();
            } finally {
                showLoading(false);
            }
        }
        
        // 显示新卡片
        function showNewCards(cards) {
            const container = document.getElementById('new-card-container');
            container.innerHTML = '';
            
            cards.forEach(card => {
                const cardElement = createNewCardElement(card);
                container.appendChild(cardElement);
            });
            
            document.getElementById('new-card-modal').style.display = 'flex';
        }
        
        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // 出售卡片
        function sellCard(index) {
            if (index >= 0 && index < collection.length) {
                const card = collection[index];
                const confirmSell = confirm(`确定要出售 ${card.name} 吗？\n获得 ${card.value} 金币`);
                
                if (confirmSell) {
                    gold += card.value;
                    collection.splice(index, 1);
                    updateGoldDisplay();
                    renderCollection();
                    updateCollectionCount();
                    
                    // 更新成就进度
                    updateAchievementProgress('sell_10', 1, true);
                    updateAchievementProgress('sell_50', 1, true);
                    updateAchievementProgress('sell_100', 1, true);
                }
            }
        }
        
        // 显示卡包信息
        function showPackInfo(packType) {
            const modal = document.getElementById('pack-info-modal');
            const title = document.getElementById('pack-info-title');
            const content = document.getElementById('pack-info-content');
            
            let packName, packDesc;
            
            switch(packType) {
                case 'basic':
                    packName = '基础卡包';
                    packDesc = '包含5张随机卡牌，主要包含普通品质的英雄和皮肤';
                    break;
                case 'premium':
                    packName = '高级卡包';
                    packDesc = '包含5张随机卡牌，主要包含稀有和史诗品质的皮肤';
                    break;
                case 'luxury':
                    packName = '豪华卡包';
                    packDesc = '包含5张随机卡牌，主要包含史诗和传说品质的皮肤';
                    break;
            }
            
            title.textContent = packName;
            
            let exampleCardsHtml = '';
            
            let exampleCards;
            if (packType === 'basic') {
                exampleCards = [
                    { name: "艾希", type: "英雄", rarity: "common", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_0.jpg" },
                    { name: "盖伦", type: "英雄", rarity: "common", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_0.jpg" },
                    { name: "拉克丝", type: "英雄", rarity: "common", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_0.jpg" },
                    { name: "经典皮肤", type: "皮肤", rarity: "common", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ashe_1.jpg" },
                    { name: "普通皮肤", type: "皮肤", rarity: "rare", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_1.jpg" }
                ];
            } else if (packType === 'premium') {
                exampleCards = [
                    { name: "神王盖伦", type: "皮肤", rarity: "epic", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_3.jpg" },
                    { name: "星之守护者拉克丝", type: "皮肤", rarity: "epic", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_2.jpg" },
                    { name: "未来战士伊泽瑞尔", type: "皮肤", rarity: "rare", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_2.jpg" },
                    { name: "元素女皇拉克丝", type: "皮肤", rarity: "epic", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_3.jpg" },
                    { name: "偶像歌手阿狸", type: "皮肤", rarity: "rare", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_3.jpg" }
                ];
            } else {
                exampleCards = [
                    { name: "K/DA阿狸", type: "皮肤", rarity: "legendary", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ahri_8.jpg" },
                    { name: "真实伤害伊泽瑞尔", type: "皮肤", rarity: "legendary", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Ezreal_8.jpg" },
                    { name: "奥德赛拉克丝", type: "皮肤", rarity: "epic", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Lux_6.jpg" },
                    { name: "神王盖伦", type: "皮肤", rarity: "legendary", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Garen_3.jpg" },
                    { name: "摄魂使者薇恩", type: "皮肤", rarity: "legendary", img: "https://ddragon.leagueoflegends.com/cdn/img/champion/loading/Vayne_6.jpg" }
                ];
            }
            
            exampleCards.forEach(card => {
                exampleCardsHtml += `
                    <div class="pack-card-example">
                        <div class="pack-card-image">
                            <img src="${card.img}" alt="${card.name}" onerror="this.src='https://picsum.photos/80/120'">
                        </div>
                        <div class="pack-card-name">${card.name}</div>
                        <div class="pack-card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                `;
            });
            
            content.innerHTML = `
                <p>${packDesc}</p>
                <p class="pack-price">价格: ${getPackPrice(packType)}金币</p>
                <h3>可能包含的卡片:</h3>
                <div class="pack-card-examples">
                    ${exampleCardsHtml}
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        // 显示图鉴
        function showHandbook() {
            const modal = document.getElementById('handbook-modal');
            modal.style.display = 'flex';
            
            // 默认显示英雄图鉴
            renderHandbook('champions');
        }
        
        // 渲染图鉴内容
        function renderHandbook(type) {
            const container = document.getElementById('handbook-content');
            container.innerHTML = '';
            
            let items = [];
            let emptyMessage = '';
            
            if (type === 'champions') {
                items = allChampions;
                emptyMessage = '没有英雄数据';
            } else {
                items = allSkins;
                emptyMessage = '没有皮肤数据';
            }
            
            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
                return;
            }
            
            items.forEach(item => {
                const isCollected = type === 'champions' 
                    ? collectedCards.champions.has(item.id)
                    : collectedCards.skins.has(item.id);
                
                const cardElement = createHandbookCardElement(item, isCollected, type);
                container.appendChild(cardElement);
            });
        }
        
        // 创建图鉴卡片元素
        function createHandbookCardElement(item, isCollected, type) {
            const cardElement = document.createElement('div');
            cardElement.className = `handbook-card ${isCollected ? '' : 'uncollected'}`;
            
            let imageUrl, name, subText;
            if (type === 'skin') {
                imageUrl = item.loadingImg;
                name = item.name;
                subText = item.championName;
            } else {
                imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${item.id}_0.jpg`;
                name = item.name;
                subText = item.title;
            }
            
            cardElement.innerHTML = `
                <img class="handbook-card-image" src="${imageUrl}" alt="${name}" 
                     onerror="this.src='${type === 'skin' ? item.portraitImg : `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${item.id}.png`}'">
                <div class="handbook-card-info">
                    <div class="handbook-card-name">${name}</div>
                    <div class="handbook-card-type">${subText}</div>
                    <div class="handbook-card-rarity">${isCollected ? '已收集' : '未收集'}</div>
                </div>
            `;
            
            return cardElement;
        }
        
        // 切换图鉴选项卡
        function switchHandbookTab(tabType) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabType) {
                    tab.classList.add('active');
                }
            });
            
            renderHandbook(tabType);
        }
        
        // 显示批量出售模态框
        function showBulkSellModal() {
            const modal = document.getElementById('bulk-sell-modal');
            modal.style.display = 'flex';
            
            // 重置选择
            document.querySelectorAll('.bulk-sell-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 渲染所有卡片
            renderBulkSellCards();
        }
        
        // 渲染批量出售卡片
        function renderBulkSellCards() {
            const container = document.getElementById('bulk-sell-container');
            container.innerHTML = '';
            
            if (collection.length === 0) {
                container.innerHTML = '<div class="empty-state">没有可出售的卡片</div>';
                return;
            }
            
            collection.forEach((card, index) => {
                const cardElement = createBulkSellCardElement(card, index);
                container.appendChild(cardElement);
            });
        }
        
        // 创建批量出售卡片元素
        function createBulkSellCardElement(card, index) {
            const cardElement = document.createElement('div');
            cardElement.className = 'card bulk-sell-card';
            cardElement.setAttribute('data-rarity', card.rarity);
            
            let imageUrl, cardTitle, cardName;
            if (card.type === 'skin') {
                imageUrl = card.skin.loadingImg;
                cardTitle = `${card.skin.name}`;
                cardName = card.skin.name;
            } else {
                imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${card.championId}_0.jpg`;
                cardTitle = card.title;
                cardName = card.name;
            }
            
            cardElement.innerHTML = `
                <div class="card-face card-front">
                    <img class="card-image" src="${imageUrl}" alt="${cardName}" 
                         onerror="this.src='${card.type === 'skin' ? card.skin.portraitImg : `https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${card.championId}.png`}'">
                    <div class="card-info">
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-name">攻击:</span>
                                <span class="stat-value">${card.type === 'skin' ? 
                                    getSkinStats(card.skin.championId, card.rarity).attack : 
                                    getChampionStats(card.championId, card.rarity).attack}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">防御:</span>
                                <span class="stat-value">${card.type === 'skin' ? 
                                    getSkinStats(card.skin.championId, card.rarity).defense : 
                                    getChampionStats(card.championId, card.rarity).defense}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">生命:</span>
                                <span class="stat-value">${card.type === 'skin' ? 
                                    getSkinStats(card.skin.championId, card.rarity).health : 
                                    getChampionStats(card.championId, card.rarity).health}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">法力:</span>
                                <span class="stat-value">${card.type === 'skin' ? 
                                    getSkinStats(card.skin.championId, card.rarity).mana : 
                                    getChampionStats(card.championId, card.rarity).mana}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-face card-back">
                    <div>
                        <h3>${cardName}</h3>
                        <p>${cardTitle}</p>
                        ${card.type === 'skin' ? `<p>英雄: ${card.skin.championName}</p>` : ''}
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                    <div class="card-value">
                        <p>价值: ${card.value}金币</p>
                        <button class="sell-btn" data-index="${index}">出售</button>
                    </div>
                </div>
            `;
            
            // 添加选择功能
            cardElement.addEventListener('click', function(e) {
                if (!e.target.classList.contains('sell-btn')) {
                    this.classList.toggle('selected');
                }
            });
            
            return cardElement;
        }
        
        // 筛选批量出售卡片
        function filterBulkSellCards() {
            const selectedRarities = Array.from(document.querySelectorAll('.bulk-sell-option.selected'))
                .map(option => option.getAttribute('data-rarity'));
            
            const cards = document.querySelectorAll('.bulk-sell-card');
            
            if (selectedRarities.length === 0) {
                cards.forEach(card => card.style.display = '');
                return;
            }
            
            cards.forEach(card => {
                const rarity = card.getAttribute('data-rarity');
                if (selectedRarities.includes(rarity)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // 全选/取消全选卡片
        function selectAllCards(select) {
            const visibleCards = Array.from(document.querySelectorAll('.bulk-sell-card'))
                .filter(card => window.getComputedStyle(card).display !== 'none');
            
            visibleCards.forEach(card => {
                if (select) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }
        
        // 确认批量出售
        function confirmBulkSell() {
            const selectedCards = Array.from(document.querySelectorAll('.bulk-sell-card.selected'));
            
            if (selectedCards.length === 0) {
                alert('请先选择要出售的卡片！');
                return;
            }
            
            const totalValue = selectedCards.reduce((sum, card) => {
                const index = parseInt(card.querySelector('.sell-btn').getAttribute('data-index'));
                return sum + collection[index].value;
            }, 0);
            
            const confirmSell = confirm(`确定要出售选中的 ${selectedCards.length} 张卡片吗？\n总共获得 ${totalValue} 金币`);
            
            if (confirmSell) {
                // 按索引从大到小排序，避免删除时索引变化
                const indices = selectedCards
                    .map(card => parseInt(card.querySelector('.sell-btn').getAttribute('data-index')))
                    .sort((a, b) => b - a);
                
                indices.forEach(index => {
                    gold += collection[index].value;
                    collection.splice(index, 1);
                });
                
                updateGoldDisplay();
                renderCollection();
                updateCollectionCount();
                closeModal('bulk-sell-modal');
                alert(`成功出售 ${indices.length} 张卡片，获得 ${totalValue} 金币！`);
                
                // 更新成就进度
                updateAchievementProgress('sell_10', indices.length, true);
                updateAchievementProgress('sell_50', indices.length, true);
                updateAchievementProgress('sell_100', indices.length, true);
            }
        }
        
        // 显示认证模态框
        function showAuthModal(type) {
            document.getElementById('auth-modal').style.display = 'flex';
            if (type === 'login') {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-error').textContent = '';
            } else {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
                document.getElementById('register-error').textContent = '';
            }
        }
        
        // 登录
        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorElement = document.getElementById('login-error');
            
            // 验证输入
            if (!email) {
                errorElement.textContent = '请输入邮箱';
                return;
            }
            
            if (!password) {
                errorElement.textContent = '请输入密码';
                return;
            }
            
            try {
                showFormLoading('login', true);
                
                // 使用await等待登录完成
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // 登录成功后关闭模态框
                closeModal('auth-modal');
                showLoading(true, '正在加载用户数据...');
                
                // 加载用户数据
                await loadUserData();
                
                // 更新UI
                updateGoldDisplay();
                renderCollection();
                updateCollectionCount();
                renderAchievements();
                
                // 检查每日奖励
                checkDailyReward();
                
            } catch (error) {
                console.error('登录失败:', error);
                let errorMessage = '登录失败，请重试';
                
                // 更详细的错误处理
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMessage = '该邮箱未注册';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '密码错误';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '邮箱格式不正确';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '尝试次数过多，请稍后再试';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = '账号已被禁用';
                        break;
                }
                
                errorElement.textContent = errorMessage;
            } finally {
                showFormLoading('login', false);
                showLoading(false);
            }
        }
        
        // 注册
        async function register() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirmPassword = document.getElementById('register-confirm').value.trim();
            const errorElement = document.getElementById('register-error');
            
            // 验证输入
            if (!name) {
                errorElement.textContent = '请输入用户名';
                return;
            }
            
            if (!email) {
                errorElement.textContent = '请输入邮箱';
                return;
            }
            
            if (!password) {
                errorElement.textContent = '请输入密码';
                return;
            }
            
            if (!confirmPassword) {
                errorElement.textContent = '请确认密码';
                return;
            }
            
            if (password !== confirmPassword) {
                errorElement.textContent = '两次输入的密码不一致';
                return;
            }
            
            if (password.length < 6) {
                errorElement.textContent = '密码长度至少为6位';
                return;
            }
            
            try {
                showFormLoading('register', true);
                
                // 1. 创建用户账号
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // 2. 更新用户显示名称
                await userCredential.user.updateProfile({
                    displayName: name
                });
                
                // 3. 创建用户文档
                await db.collection('users').doc(userCredential.user.uid).set({
                    uid: userCredential.user.uid,
                    displayName: name,
                    email: email,
                    gold: 1000,
                    collection: [],
                    collectedCards: {
                        champions: [],
                        skins: []
                    },
                    dailyRewardClaimed: false,
                    consecutiveDays: 0,
                    lastClaimDate: null,
                    achievements: achievements,
                    battleStats: battleStats,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // 注册成功后自动登录
                await login();
                
            } catch (error) {
                console.error('注册失败:', error);
                let errorMessage = '注册失败，请重试';
                
                // 更详细的错误处理
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = '该邮箱已被注册';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '邮箱格式不正确';
                        break;
                    case 'auth/weak-password':
                        errorMessage = '密码强度不足，请使用更复杂的密码';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = '操作不被允许，请联系管理员';
                        break;
                }
                
                errorElement.textContent = errorMessage;
            } finally {
                showFormLoading('register', false);
            }
        }
        
        // 退出登录
        async function logout() {
            try {
                await auth.signOut();
                // 重置游戏状态
                gold = 1000;
                collection = [];
                collectedCards = {
                    champions: new Set(),
                    skins: new Set()
                };
                updateGoldDisplay();
                renderCollection();
                updateCollectionCount();
                renderAchievements();
            } catch (error) {
                console.error('退出登录失败:', error);
                alert('退出登录失败: ' + error.message);
            }
        }
        
        // 检查每日奖励
        function checkDailyReward() {
            if (isGuest) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (lastClaimDate) {
                const lastClaim = new Date(lastClaimDate);
                lastClaim.setHours(0, 0, 0, 0);
                
                const diffTime = today - lastClaim;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    // 今天已经领取过
                    dailyRewardClaimed = true;
                } else if (diffDays === 1) {
                    // 连续登录
                    consecutiveDays++;
                } else {
                    // 中断连续登录
                    consecutiveDays = 1;
                }
            } else {
                // 第一次领取
                consecutiveDays = 1;
            }
            
            // 更新每日奖励按钮状态
            document.getElementById('daily-reward-btn').disabled = dailyRewardClaimed;
            
            // 更新成就进度
            updateAchievementProgress('daily_7', consecutiveDays);
            updateAchievementProgress('daily_30', consecutiveDays);
        }
        
        // 显示每日奖励模态框
        function showDailyRewardModal() {
            const modal = document.getElementById('daily-reward-modal');
            const content = document.getElementById('daily-reward-info');
            
            // 计算奖励
            const baseReward = 100;
            const bonusReward = Math.min(consecutiveDays * 50, 500); // 最多500金币
            const totalReward = baseReward + bonusReward;
            
            // 更新进度条
            const progress = Math.min(consecutiveDays / 7, 1) * 100;
            document.getElementById('daily-progress').style.width = `${progress}%`;
            
            content.innerHTML = `
                <p>连续登录天数: ${consecutiveDays}天</p>
                <p>基础奖励: ${baseReward}金币</p>
                <p>连续登录奖励: +${bonusReward}金币</p>
                <h3>总计: ${totalReward}金币</h3>
            `;
            
            modal.style.display = 'flex';
        }
        
        // 领取每日奖励
        async function claimDailyReward() {
            if (dailyRewardClaimed) return;
            
            // 计算奖励
            const baseReward = 100;
            const bonusReward = Math.min(consecutiveDays * 50, 500); // 最多500金币
            const totalReward = baseReward + bonusReward;
            
            gold += totalReward;
            dailyRewardClaimed = true;
            lastClaimDate = new Date();
            
            // 保存数据
            await saveUserData();
            
            // 更新UI
            updateGoldDisplay();
            document.getElementById('daily-reward-btn').disabled = true;
            closeModal('daily-reward-modal');
            
            alert(`成功领取每日奖励！获得 ${totalReward} 金币`);
        }
        
        // 显示图片放大模态框
        function showImageModal(imgSrc) {
            document.getElementById('modal-image').src = imgSrc;
            document.getElementById('image-modal').style.display = 'flex';
        }
        
        // 显示不同游戏部分
        function showSection(section) {
            // 更新导航菜单
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === section) {
                    item.classList.add('active');
                }
            });
            
            // 隐藏所有部分
            document.querySelectorAll('.game-section').forEach(sec => {
                sec.style.display = 'none';
            });
            
            // 显示选中的部分
            document.getElementById(`${section}-section`).style.display = 'block';
            
            // 特殊处理对战部分
            if (section === 'battle') {
                renderBattleSelection();
            }
            
            // 特殊处理成就部分
            if (section === 'achievements') {
                renderAchievements();
            }
        }
        
        // 渲染成就系统
        function renderAchievements() {
            const container = document.getElementById('achievements-container');
            container.innerHTML = '';
            
            achievements.forEach(ach => {
                const achElement = document.createElement('div');
                achElement.className = `achievement ${ach.completed ? '' : 'locked'}`;
                
                let progressHtml = '';
                if (ach.target) {
                    const progress = Math.min(ach.progress / ach.target * 100, 100);
                    progressHtml = `
                        <div class="achievement-progress">
                            <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <div>${ach.progress}/${ach.target}</div>
                    `;
                }
                
                achElement.innerHTML = `
                    <div class="achievement-icon">${ach.completed ? '✓' : '?'}</div>
                    <div class="achievement-name">${ach.name}</div>
                    <div class="achievement-desc">${ach.desc}</div>
                    <div>奖励: ${ach.reward}金币</div>
                    ${progressHtml}
                `;
                
                container.appendChild(achElement);
            });
        }
        
        // 检查成就
        function checkAchievement(achievementId) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement || achievement.completed) return;
            
            achievement.completed = true;
            gold += achievement.reward;
            updateGoldDisplay();
            saveUserData();
            
            // 如果是首次开包成就，显示提示
            if (achievementId === 'first_pack') {
                alert(`恭喜获得成就"${achievement.name}"！获得 ${achievement.reward} 金币`);
            }
            
            renderAchievements();
        }
        
        // 更新成就进度
        function updateAchievementProgress(achievementId, progress, isIncrement = false) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement || achievement.completed) return;
            
            if (isIncrement) {
                achievement.progress += progress;
            } else {
                achievement.progress = progress;
            }
            
            if (achievement.progress >= achievement.target) {
                achievement.completed = true;
                gold += achievement.reward;
                updateGoldDisplay();
                
                // 显示成就完成提示
                alert(`恭喜完成成就"${achievement.name}"！获得 ${achievement.reward} 金币`);
            }
            
            saveUserData();
            renderAchievements();
        }
        
        // 渲染对战选择卡牌
        function renderBattleSelection() {
            const container = document.getElementById('battle-select-container');
            container.innerHTML = '';
            
            if (collection.length === 0) {
                container.innerHTML = '<div class="empty-state">你还没有任何卡片，快去开包吧！</div>';
                document.getElementById('battle-btn').disabled = true;
                return;
            }
            
            // 只显示英雄卡牌
            const heroCards = collection.filter(card => card.type === 'champion');
            
            if (heroCards.length === 0) {
                container.innerHTML = '<div class="empty-state">你还没有英雄卡片，快去开包吧！</div>';
                document.getElementById('battle-btn').disabled = true;
                return;
            }
            
            heroCards.forEach((card, index) => {
                const cardElement = createBattleSelectionCardElement(card, index);
                container.appendChild(cardElement);
            });
            
            // 默认选择第一张卡牌
            if (heroCards.length > 0 && !selectedBattleCard) {
                selectBattleCard(0);
            }
        }
        
        // 创建对战选择卡牌元素
        function createBattleSelectionCardElement(card, index) {
            const cardElement = document.createElement('div');
            cardElement.className = `card ${selectedBattleCard === index ? 'selected' : ''}`;
            cardElement.setAttribute('data-index', index);
            
            const imageUrl = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${card.championId}_0.jpg`;
            const stats = getChampionStats(card.championId, card.rarity);
            
            cardElement.innerHTML = `
                <div class="card-face card-front">
                    <img class="card-image" src="${imageUrl}" alt="${card.name}" 
                         onerror="this.src='https://ddragon.leagueoflegends.com/cdn/${CURRENT_VERSION}/img/champion/${card.championId}.png'">
                    <div class="card-info">
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <span class="stat-name">攻击:</span>
                                <span class="stat-value">${stats.attack}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">防御:</span>
                                <span class="stat-value">${stats.defense}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">生命:</span>
                                <span class="stat-value">${stats.health}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-name">法力:</span>
                                <span class="stat-value">${stats.mana}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-face card-back">
                    <div>
                        <h3>${card.name}</h3>
                        <p>${card.title}</p>
                        <div class="card-rarity ${card.rarity}">${getRarityName(card.rarity)}</div>
                    </div>
                </div>
            `;
            
            cardElement.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                selectBattleCard(index);
            });
            
            return cardElement;
        }
        
        // 选择对战卡牌
        function selectBattleCard(index) {
            selectedBattleCard = index;
            
            // 更新选中状态
            document.querySelectorAll('#battle-select-container .card').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.querySelector(`#battle-select-container .card[data-index="${index}"]`).classList.add('selected');
            
            // 更新玩家卡牌显示
            const card = collection[index];
            const stats = getChampionStats(card.championId, card.rarity);
            
            document.getElementById('player-card-image').src = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${card.championId}_0.jpg`;
            document.getElementById('player-card-name').textContent = card.name;
            document.getElementById('player-attack').textContent = stats.attack;
            document.getElementById('player-defense').textContent = stats.defense;
            document.getElementById('player-health').textContent = stats.health;
            document.getElementById('player-mana').textContent = stats.mana;
            
            document.getElementById('battle-btn').disabled = false;
            document.getElementById('battle-result').textContent = '';
        }
        
        // 开始对战
        function startBattle() {
            if (selectedBattleCard === null) return;
            
            const playerCard = collection[selectedBattleCard];
            const playerStats = getChampionStats(playerCard.championId, playerCard.rarity);
            
            // 随机选择对手卡牌
            const opponentIndex = Math.floor(Math.random() * allChampions.length);
            const opponentChampion = allChampions[opponentIndex];
            const opponentRarity = Math.random() > 0.7 ? 'rare' : 'common'; // 30%几率稀有卡
            const opponentStats = getChampionStats(opponentChampion.id, opponentRarity);
            
            // 更新对手卡牌显示
            document.getElementById('opponent-card-image').src = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/${opponentChampion.id}_0.jpg`;
            document.getElementById('opponent-card-name').textContent = opponentChampion.name;
            document.getElementById('opponent-attack').textContent = opponentStats.attack;
            document.getElementById('opponent-defense').textContent = opponentStats.defense;
            document.getElementById('opponent-health').textContent = opponentStats.health;
            document.getElementById('opponent-mana').textContent = opponentStats.mana;
            
            // 计算战斗结果
            const playerPower = playerStats.attack * 0.4 + playerStats.defense * 0.3 + playerStats.health * 0.2 + playerStats.mana * 0.1;
            const opponentPower = opponentStats.attack * 0.4 + opponentStats.defense * 0.3 + opponentStats.health * 0.2 + opponentStats.mana * 0.1;
            
            // 添加一些随机因素
            const randomFactor = 0.8 + Math.random() * 0.4;
            const adjustedPlayerPower = playerPower * randomFactor;
            const adjustedOpponentPower = opponentPower * (1.2 - randomFactor);
            
            // 确定胜负
            let resultText, isWin;
            if (adjustedPlayerPower > adjustedOpponentPower * 1.1) {
                resultText = `胜利！你的${playerCard.name}击败了${opponentChampion.name}`;
                isWin = true;
            } else if (adjustedPlayerPower * 1.1 < adjustedOpponentPower) {
                resultText = `失败！${opponentChampion.name}击败了你的${playerCard.name}`;
                isWin = false;
            } else {
                resultText = `平局！你的${playerCard.name}与${opponentChampion.name}势均力敌`;
                isWin = false;
            }
            
            document.getElementById('battle-result').textContent = resultText;
            
            // 更新对战统计
            if (isWin) {
                battleStats.wins++;
                updateAchievementProgress('win_5', 1, true);
                updateAchievementProgress('win_20', 1, true);
                updateAchievementProgress('win_50', 1, true);
            } else {
                battleStats.losses++;
            }
            
            // 获得奖励
            const reward = isWin ? 100 : 50;
            gold += reward;
            updateGoldDisplay();
            
            // 保存数据
            saveUserData();
        }
        
        // 初始化游戏
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
